# 行情订阅功能使用说明

## 概述

`QuoteSubscriber` 类提供了行情数据的订阅功能，可以每1.9秒（可自定义）自动向订阅者推送最新的行情数据。

## 基本用法

### 1. 导入模块

```python
from xtdata_quote import QuoteSubscriber
import pandas as pd
```

### 2. 创建订阅管理器

```python
# 订阅指定的股票代码
subscriber = QuoteSubscriber(["600519.SH", "000001.SZ"])
```

### 3. 定义回调函数

```python
def on_data_received(df: pd.DataFrame) -> None:
    """处理接收到的行情数据。"""
    print(df)
```

### 4. 订阅数据推送

```python
subscriber.subscribe(on_data_received)
```

### 5. 保持程序运行

```python
import time

try:
    while True:
        time.sleep(1)
except KeyboardInterrupt:
    subscriber.stop()
```

## 完整示例

```python
import time
from xtdata_quote import QuoteSubscriber
import pandas as pd

def on_data_received(df: pd.DataFrame) -> None:
    """数据推送回调函数。"""
    print(f"\n[{time.strftime('%H:%M:%S')}] 收到行情数据:")
    print(df[["price", "last_close", "vol", "amount"]])

# 创建订阅管理器
subscriber = QuoteSubscriber(["600519.SH", "000001.SZ"])

# 订阅数据推送
subscriber.subscribe(on_data_received)

print("已开始订阅，等待数据推送...")
print("按 Ctrl+C 停止订阅\n")

try:
    while True:
        time.sleep(1)
except KeyboardInterrupt:
    print("\n停止订阅...")
    subscriber.stop()
```

## 使用上下文管理器

```python
with QuoteSubscriber(["600519.SH"]) as subscriber:
    subscriber.subscribe(on_data_received)
    time.sleep(10)  # 运行10秒
# 自动停止订阅
```

## 多个订阅者

```python
def callback1(df: pd.DataFrame) -> None:
    print("订阅者1收到数据")

def callback2(df: pd.DataFrame) -> None:
    print("订阅者2收到数据")

subscriber = QuoteSubscriber(["600519.SH"])
subscriber.subscribe(callback1)
subscriber.subscribe(callback2)
```

## 动态订阅和取消订阅

```python
subscriber = QuoteSubscriber(["600519.SH"])

# 添加订阅
subscriber.subscribe(callback1)

# 取消订阅
subscriber.unsubscribe(callback1)

# 重新订阅
subscriber.subscribe(callback1)
```

## 自定义推送间隔

```python
# 设置推送间隔为3秒（默认1.9秒）
subscriber = QuoteSubscriber(["600519.SH"], interval=3.0)
```

## 参数说明

### QuoteSubscriber 初始化参数

- `stock_codes`: 要订阅的股票代码列表，例如 `["600519.SH", "000001.SZ"]`
- `host`: 通达信行情服务器地址（可选，默认使用内置稳定主站）
- `port`: 通达信行情服务器端口（可选，默认7709）
- `interval`: 推送间隔（秒），默认1.9秒

### 方法说明

- `subscribe(callback)`: 订阅数据推送
  - `callback`: 回调函数，接收 `pd.DataFrame` 作为参数
  
- `unsubscribe(callback)`: 取消订阅
  - `callback`: 要取消的回调函数
  
- `stop()`: 停止订阅服务，清除所有订阅者

## 运行示例程序

运行 `subscribe_example.py` 查看更多详细示例：

```bash
python md/tdx/subscribe_example.py
```

示例程序包含以下场景：
1. 基本订阅用法
2. 多个订阅者同时订阅
3. 使用上下文管理器
4. 动态订阅和取消订阅
5. 自定义推送间隔
6. 在回调中进行数据处理

## 注意事项

1. 订阅管理器会在后台启动一个线程来推送数据
2. 回调函数中的异常不会影响其他订阅者
3. 如果没有订阅者，推送线程会自动停止
4. 使用 `stop()` 方法或上下文管理器退出时会自动清理资源
5. 推送的数据格式与 `fetch_quotes_basic()` 返回的格式相同，只包含核心字段

## 数据格式

推送的 DataFrame 包含以下字段（如果可用）：
- `code`: 股票代码
- `servertime`: 服务器时间
- `price`: 当前价格
- `ask1`: 卖一价
- `bid1`: 买一价
- `last_close`: 昨收价
- `open`: 开盘价
- `high`: 最高价
- `low`: 最低价
- `vol`: 成交量
- `cur_vol`: 当前成交量
- `amount`: 成交额

