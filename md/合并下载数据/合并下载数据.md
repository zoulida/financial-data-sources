# 股票数据下载模块文档

## 模块概述

本模块提供了股票行情数据的下载和获取功能，支持单只股票和批量股票的数据下载。主要使用迅投(XTQuant)数据接口进行数据获取。

## 主要功能函数

合并下载数据模块的相对路径：source\实盘\xuntou\datadownload\合并下载数据.py
from source.实盘.xuntou.datadownload.合并下载数据 import getDayData

### 1. getDayData - 获取单只股票日K线数据

**功能描述**: 获取单只股票的日K线数据，支持从本地CSV缓存读取或重新下载。

**函数签名**:
```python
def getDayData(stock_code="600519.SH", start_date='20240101', end_date="", is_download=0, dividend_type='front')
```

**参数说明**:
- `stock_code` (str): 股票代码，格式如"600519.SH"，必填
- `start_date` (str): 开始日期，格式为'YYYYMMDD'，必填
- `end_date` (str): 结束日期，格式为'YYYYMMDD'，必填
- `is_download` (int): 是否重新下载数据，0=从缓存读取，1=重新下载
- `dividend_type` (str): 复权类型
  - 'none': 不复权
  - 'front': 前复权（默认）
  - 'back': 后复权

**返回值**:
- `pandas.DataFrame`: 包含以下列的股票日K线数据
  - `date`: 交易日期（字符串格式）
  - `open`: 开盘价
  - `high`: 最高价
  - `low`: 最低价
  - `close`: 收盘价
  - `volume`: 成交量
  - `amount`: 成交额

**使用示例**:
```python
# 获取贵州茅台2024年1月1日到2024年12月31日的前复权数据
data = getDayData(
    stock_code="600519.SH",
    start_date="20240101",
    end_date="20241231",
    is_download=0,  # 从缓存读取
    dividend_type='front'
)
print(data.head())
```

### 2. batchDownloadDayData - 批量下载多只股票日K线数据

**功能描述**: 批量下载多只股票的日K线数据，适用于下载100只以上股票的场景。支持数据完整性检查和失败重试机制。

**函数签名**:
```python
def batchDownloadDayData(stock_codes=["600519.SH",'600016.SH'], start_date='20240101', end_date="", dividend_type='front', need_download=1, batchNum=None)
```

**参数说明**:
- `stock_codes` (list): 股票代码列表，如["600519.SH", "600016.SH"]，必填
- `start_date` (str): 开始日期，格式为'YYYYMMDD'，必填
- `end_date` (str): 结束日期，格式为'YYYYMMDD'，必填
- `dividend_type` (str): 复权类型，同getDayData
- `need_download` (int): 是否下载数据，1=下载，0=仅从本地读取
- `batchNum` (int, optional): 批次号，用于日志记录

**返回值**:
- `dict`: 以股票代码为键，DataFrame为值的字典
  - 键: 股票代码（str）
  - 值: 包含日K线数据的DataFrame（格式同getDayData返回值）

**特殊功能**:
1. **数据完整性检查**: 自动检查下载数据的最后日期是否等于目标结束日期
2. **失败重试机制**: 数据不完整时自动重试最多5次
3. **失败日志记录**: 下载失败的股票会记录到faillog目录下的CSV文件
4. **低价股过滤**: 自动跳过开盘价小于2元的股票（可能是停牌股票）

**使用示例**:
```python
# 批量下载多只股票数据
stock_list = ["600519.SH", "600036.SH", "000001.SZ", "000002.SZ"]
data_dict = batchDownloadDayData(
    stock_codes=stock_list,
    start_date="20240101",
    end_date="20241231",
    dividend_type='front',
    need_download=1
)

# 查看结果
print(f"成功下载 {len(data_dict)} 只股票的数据")
for code, df in data_dict.items():
    print(f"{code}: {len(df)} 条记录")
```

## 辅助函数

### 3. getDayDataCache - 带缓存的日K线数据获取

**功能描述**: 带LRU缓存的日K线数据获取函数，避免重复计算。

**函数签名**:
```python
@lru_cache
def getDayDataCache(stock_code="600519.SH", start_date='20240101', end_date="", is_download=0, dividend_type='front')
```

**参数**: 同getDayData
**返回值**: 同getDayData

### 4. get_tick_data - 获取tick数据

**功能描述**: 获取单只股票的tick级别数据。

**函数签名**:
```python
def get_tick_data(stock_list=['600036.SH'], start_time='20250530093000')
```

**参数说明**:
- `stock_list` (list): 股票代码列表
- `start_time` (str): 开始时间，格式为'YYYYMMDDHHMMSS'

**返回值**:
- `pandas.DataFrame`: tick数据，包含date列（时间戳）

### 5. get_batch_tick_data - 批量获取tick数据

**函数签名**:
```python
def get_batch_tick_data(stock_list=['600036.SH'], start_time='20250528093000')
```

**返回值**:
- `dict`: 以股票代码为键，DataFrame为值的字典

## 数据存储

### CSV文件存储路径

数据会按照以下规则保存到CSV文件：
- 路径格式: `{项目根目录}/data/csv/{函数名}_{参数组合}.csv`
- 例如: `data/csv/getDayKlineData_600519.SH_20240101_20241231_front.csv`

### 失败日志存储

下载失败的股票会记录到：
- 路径: `{当前文件目录}/faillog/getDayKlineData_{开始日期}-{结束日期}-{复权类型}_failDownload.csv`
- 包含字段: stock_code, fail_time, fail_type

## 使用建议

1. **单只股票**: 使用`getDayData`函数
2. **批量下载（<100只）**: 使用`getDayData`循环调用
3. **批量下载（≥100只）**: 使用`batchDownloadDayData`函数
4. **数据缓存**: 优先使用`getDayDataCache`避免重复计算
5. **数据完整性**: 批量下载会自动检查数据完整性，建议使用

## 注意事项

1. 所有日期参数必须为'YYYYMMDD'格式的字符串
2. 股票代码必须包含市场后缀（如.SH, .SZ）
3. 批量下载时建议设置合理的批次大小，避免内存溢出
4. 网络不稳定时，批量下载会自动重试
5. 数据下载需要有效的迅投数据接口授权

## 错误处理

- 参数验证: 缺少必填参数会抛出ValueError
- 数据下载失败: 会记录到失败日志并继续处理其他股票
- 网络异常: 自动重试机制，最多重试5次
- 数据不完整: 自动检测并重新下载
