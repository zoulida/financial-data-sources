# ST摘帽预测脚本使用说明

## 功能概述

本脚本使用Wind API获取A股财务数据，预测全年财务指标，并筛选出可能摘帽的ST股票。

## 主要功能

### 1. 数据获取
- **1-3季度累计数据**：归母净利润、扣非净利润、营业收入、毛利率、期间费用率、财务费用、净资产、非经常性损益、分红计划
- **Q3单季数据**：单季营收、单季同比、单季毛利率、单季期间费用率
- **最新总市值**：使用w.wss获取
- **Q4营收占比**：最近2年四季度营收占比均值
- **其他数据**：审计意见代码、违规立案标识、经营现金流

### 2. 全年预测
- **Q4营收预测**：
  - 方法1：Q4营收 = Q3单季营收 × (1 + Q3单季营收同比)
  - 方法2：如果Q4占比>40%，则使用占比修正：Q4营收 = 全年营收指引 × Q4占比
- **全年营收** = Q1+Q2+Q3累计 + Q4营收
- **全年毛利** = 全年营收 × Q3毛利率（单季）
- **全年费用** = 全年营收 × Q3期间费用率（单季）
- **全年净利** = (毛利 - 费用 - 财务费用年化) × (1-0.25) + 非经常损益指引
- **全年扣非** = 全年净利 - 非经常损益指引
- **年末净资产** = Q3净资产 + 全年净利 - 分红计划

### 3. 打分系统

#### 硬门槛（6项，每项1分）
1. 净利>0
2. 扣非>0
3. 营收≥1亿
4. 净资产>0
5. 审计意见∈{1,2}
6. 违规标识=0

#### 软指标（4项，每项1分）
1. 经营现金流/营收≥0.7
2. 毛利率同比>0（需要历史数据，当前版本暂未实现）
3. 期间费用率同比<0（需要历史数据，当前版本暂未实现）
4. 预告披露日≤1月31日（需要预告数据，当前版本暂未实现）

**总分范围**：0-10分

### 4. 筛选条件
- 总分≥7
- 总市值≤30亿

### 5. 排序规则
- 按总分降序
- 按市值升序

### 6. 输出结果
生成CSV文件：`st摘帽候选.csv`

输出列：
- `code`: 股票代码
- `name`: 股票名称
- `score`: 总分
- `预测全年净利`: 预测的全年净利润
- `预测全年扣非`: 预测的全年扣非净利润
- `预测年末净资产`: 预测的年末净资产
- `总市值`: 总市值（单位：元）
- `备注`: 备注信息

## 使用方法

### 环境要求
- Python 3.x
- Wind API（WindPy）
- pandas
- numpy

### 运行脚本
```bash
python st_摘帽预测.py
```

### 输出说明
- 程序运行完成后，会在当前目录生成 `st摘帽候选.csv` 文件
- 控制台会打印前20行结果

## 注意事项

1. **Wind API连接**：确保Wind终端已启动并登录
2. **数据获取**：程序会分批获取数据，可能需要较长时间
3. **字段缺失**：某些字段可能在Wind API中不存在或获取失败，程序会使用默认值或跳过
4. **异常处理**：若某字段返回None/NaN，则该项得分强制给0
5. **软指标**：当前版本中，部分软指标（毛利率同比、期间费用率同比、预告披露日）需要额外数据，暂未完全实现

## 字段说明

### Wind API字段映射
- `np_belongto_parcomsh`: 归属母公司股东的净利润
- `deductedprofit_ttm2`: 扣除非经常性损益后归属母公司股东的净利润（TTM）
- `oper_rev`: 营业收入
- `grossprofitmargin`: 销售毛利率
- `expensetosales`: 销售期间费用率
- `fin_exp_is`: 财务费用
- `eqy_belongto_parcomsh`: 归属母公司股东的权益（净资产）
- `div_aualcashdividend`: 年度现金分红总额
- `fa_nrgl`: 非经常性损益
- `net_cash_flows_oper_act`: 经营活动产生的现金流量净额
- `mkt_cap_ard`: 总市值

## 代码结构

```
ST摘帽预测器
├── get_stock_universe()          # 获取A股全部股票
├── fetch_quarterly_data()        # 获取1-3季度累计数据
├── fetch_q3_single_quarter_data() # 获取Q3单季数据
├── fetch_market_cap()            # 获取总市值
├── fetch_q4_revenue_ratio()      # 获取Q4营收占比
├── fetch_additional_data()       # 获取其他数据
├── get_stock_names()             # 获取股票名称
├── predict_full_year()           # 预测全年数据
├── calculate_score()             # 计算得分
├── filter_and_sort()             # 筛选和排序
└── run()                         # 主流程
```

## 后续优化建议

1. **完善软指标**：
   - 实现毛利率同比和期间费用率同比的计算
   - 实现预告披露日的获取

2. **优化数据获取**：
   - 增加缓存机制，避免重复获取
   - 优化批量获取逻辑，提高效率

3. **增强异常处理**：
   - 更完善的错误处理和日志记录
   - 数据验证和清洗

4. **扩展功能**：
   - 支持自定义筛选条件
   - 支持多年度对比分析
   - 生成详细的分析报告

## 版本信息

- **版本**：1.0
- **日期**：2025-01-20
- **作者**：AI Assistant

