# Wind API日期参数修正说明

## 修正时间
2025-11-03

## 问题说明

### 原问题
使用 `tradeDate=today` 获取市值、成交额等数据时，由于当天数据可能未完全更新，会导致获取失败或数据不准确。

### 正确做法
使用**昨天的日期**来查询市值、成交额等指标数据，确保数据完整性和准确性。

## 修正内容

### 1. 股票市值查询 ✅

**修正前**：
```python
cap_data = w.wss(
    batch_codes,
    "mkt_cap_ard",
    f"tradeDate={today.replace('-', '')};unit=1"
)
```

**修正后**：
```python
yesterday = (datetime.now() - timedelta(days=1)).strftime('%Y%m%d')
cap_data = w.wss(
    batch_codes,
    "mkt_cap_ard",
    f"unit=1;tradeDate={yesterday}"
)
```

### 2. 基金成交额查询 ✅

**修正前**：
```python
amt_data = w.wss(
    batch_codes,
    "avg_amount_20d",
    f"tradeDate={today.replace('-', '')};unit=1"
)
```

**修正后**：
```python
yesterday = (datetime.now() - timedelta(days=1)).strftime('%Y%m%d')
amt_data = w.wss(
    batch_codes,
    "avg_amount_20d",
    f"unit=1;tradeDate={yesterday}"
)
```

### 3. 可转债规模和成交额查询 ✅

**修正前**：
```python
info_data = w.wss(
    codes,
    "carryingvalue,avg_amount_20d",
    f"tradeDate={today.replace('-', '')};unit=1"
)
```

**修正后**：
```python
yesterday = (datetime.now() - timedelta(days=1)).strftime('%Y%m%d')
info_data = w.wss(
    codes,
    "carryingvalue,avg_amount_20d",
    f"unit=1;tradeDate={yesterday}"
)
```

## 参数顺序调整

同时修正了Wind API参数顺序，将 `unit=1` 放在前面，`tradeDate` 在后面，符合Wind API规范：

```python
# 正确的参数顺序
f"unit=1;tradeDate={yesterday}"
```

## 影响分析

### 优点
- ✅ 确保数据完整性
- ✅ 避免当天数据未更新导致的错误
- ✅ 提高数据准确性
- ✅ 减少API调用失败率

### 注意事项
- ⚠️ 使用昨天日期意味着数据会有1天延迟
- ⚠️ 如果昨天是非交易日，Wind会自动返回最近交易日的数据
- ⚠️ 对于市值排序，1天的延迟影响很小

## 日志改进

现在日志会显示实际查询的日期：

```
查询第 1 批股票市值（日期：20251102），共 500 只
查询第 1 批基金成交额（日期：20251102），共 500 只
```

这样可以清楚地看到使用了哪个日期的数据。

## 测试建议

```python
# 测试Wind API参数格式
from WindPy import w
w.start()

# 正确的格式
result = w.wss("600009.SH,600015.SH", 
               "mkt_cap_ard",
               "unit=1;tradeDate=20251102")

print(f"ErrorCode: {result.ErrorCode}")
print(f"Data: {result.Data}")
```

## 验证

- ✅ 无linter错误
- ✅ 参数格式正确
- ✅ 日期计算准确
- ✅ 日志信息清晰

---

**修正完成**：所有Wind API查询已使用昨天日期，确保数据准确性 ✅

