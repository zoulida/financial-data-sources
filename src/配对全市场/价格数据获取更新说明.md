# 价格数据获取更新说明

## 更新时间
2025-11-03

## 更新内容

### 1. 使用 `getDayData` 替代 Wind API 获取价格数据

**原因**：
- `getDayData` 使用迅投(XtQuant)数据接口，性能更好
- 支持本地CSV缓存，减少API调用
- 数据完整性更好

**实现方式**：
- 优先使用 `getDayData` 获取价格数据
- 如果 `getDayData` 不可用或失败，自动降级到 Wind API
- 保持向后兼容性

### 2. 使用 `get_date_range` 获取日期范围

**原因**：
- 自动判断当前是否为交易日
- 根据时间（21点前后）自动选择正确的结束日期
- 确保数据获取的准确性

**实现方式**：
- 使用 `get_date_range()` 获取 `end_date`
- 根据需要的回溯天数计算 `start_date`
- 如果 `get_date_range` 不可用，使用默认日期计算

## 代码变更

### 导入模块

```python
# 导入合并下载数据模块
try:
    from source.实盘.xuntou.datadownload.合并下载数据 import getDayData
    GET_DAY_DATA_AVAILABLE = True
except ImportError:
    logger.warning("无法导入合并下载数据模块，将使用Wind API获取价格数据")
    getDayData = None
    GET_DAY_DATA_AVAILABLE = False

# 导入日期范围获取工具
try:
    from md.获取enddate.get_date_range import get_date_range
    GET_DATE_RANGE_AVAILABLE = True
except ImportError:
    logger.warning("无法导入get_date_range模块，将使用默认日期计算方式")
    get_date_range = None
    GET_DATE_RANGE_AVAILABLE = False
```

### 价格数据获取函数 `_fetch_price_data`

**变更前**：仅使用 Wind API `w.wsd` 获取数据

**变更后**：
1. 优先使用 `getDayData` 获取数据
2. 将 DataFrame 转换为 Series（使用 close 列）
3. 如果失败，自动降级到 Wind API

```python
@shelve_me_week
def _fetch_price_data(code: str, start_date: str, end_date: str, dividend_type: str) -> pd.Series:
    # 优先使用 getDayData
    if GET_DAY_DATA_AVAILABLE and getDayData is not None:
        try:
            df = getDayData(
                stock_code=code,
                start_date=start_date,
                end_date=end_date,
                is_download=0,  # 从缓存读取
                dividend_type=dividend_type
            )
            # 转换为Series
            # ...
        except Exception as e:
            logger.warning(f"getDayData获取数据失败: {code}, 错误: {e}, 尝试使用Wind API")
    
    # 使用Wind API作为备选方案
    # ...
```

### 日期范围获取 `get_price_data`

**变更前**：使用当前日期和回溯天数直接计算

**变更后**：
1. 使用 `get_date_range()` 获取准确的结束日期
2. 根据结束日期和回溯天数计算开始日期

```python
def get_price_data(self, code: str, days: int = None) -> pd.Series:
    # 使用 get_date_range 获取结束日期
    if GET_DATE_RANGE_AVAILABLE and get_date_range is not None:
        try:
            _, end_date, reason = get_date_range()
            # 根据结束日期和回溯天数计算开始日期
            start_date_obj = datetime.strptime(end_date, '%Y%m%d') - timedelta(days=int(days*1.5))
            start_date = start_date_obj.strftime('%Y%m%d')
        except Exception as e:
            # fallback到默认方式
            # ...
```

## 日期范围逻辑

### get_date_range 规则

根据 `get_date_range.py` 的实现：

1. **start_date**: 固定为 `"20241101"`（此模块固定值，实际不使用）
2. **end_date** 逻辑：
   - 如果当天是交易日：
     - 21点之后：`end_date` 为当天日期
     - 21点之前：`end_date` 为上一个交易日
   - 如果当天不是交易日：`end_date` 为上一个交易日

### 实际使用

在我们的实现中：
- 只使用 `get_date_range()` 返回的 `end_date`
- `start_date` 根据 `end_date` 和需要的回溯天数计算
- 公式：`start_date = end_date - timedelta(days=回溯天数*1.5)`（多取一些确保够用）

## 数据格式

### getDayData 返回格式

`getDayData` 返回 `pandas.DataFrame`，包含以下列：
- `date`: 交易日期（字符串格式）
- `open`: 开盘价
- `high`: 最高价
- `low`: 最低价
- `close`: 收盘价
- `volume`: 成交量
- `amount`: 成交额

### 转换处理

1. 将 `date` 列转换为日期类型
2. 使用 `close` 列创建 Series
3. 以 `date` 作为索引
4. 返回 `pd.Series`，格式与之前 Wind API 返回的格式一致

## 降级策略

### 模块导入失败

如果 `getDayData` 或 `get_date_range` 导入失败：
- 记录警告日志
- 继续使用 Wind API 和默认日期计算
- 系统仍可正常运行

### getDayData 调用失败

如果在调用 `getDayData` 时发生异常：
- 记录警告日志
- 自动降级到 Wind API
- 确保数据获取不会中断

## 优势

1. **性能提升**：使用 XtQuant 接口，数据获取更快
2. **缓存支持**：本地CSV缓存，减少重复下载
3. **数据准确性**：智能日期判断，确保获取最新可用数据
4. **向后兼容**：如果新模块不可用，自动降级到原有方案
5. **灵活性**：支持多种复权类型和日期范围

## 注意事项

1. **模块路径**：确保 `source.实盘.xuntou.datadownload.合并下载数据` 模块在 Python 路径中
2. **日期格式**：所有日期参数均为 `YYYYMMDD` 格式的字符串
3. **复权类型**：支持 `'front'`（前复权）、`'back'`（后复权）、`'none'`（不复权）
4. **数据缓存**：`getDayData` 默认从缓存读取（`is_download=0`），如需重新下载设置为 `1`

## 测试建议

1. 测试模块导入是否正常
2. 测试 `getDayData` 获取单只股票数据
3. 测试 `get_date_range` 获取日期范围
4. 测试降级机制（模拟模块不可用情况）
5. 验证返回的 Series 格式是否正确

---

**状态**: ✅ 更新完成，支持使用 getDayData 和 get_date_range

