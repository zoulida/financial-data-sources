# Wind API成交额查询优化说明

## 更新时间
2025-11-03

## 优化内容

### 字段变更：从 avg_amount_20d 改为 amt_nd ✅

**变更前**：
```python
amt_data = w.wss(
    batch_codes,
    "avg_amount_20d",
    f"unit=1;tradeDate={yesterday}"
)
```

**变更后**：
```python
amt_data = w.wss(
    batch_codes,
    "amt_nd",
    f"unit=1;tradeDate={yesterday};cycle=D;priceAdj=U;days=-20"
)
```

### 参数说明

| 参数 | 值 | 说明 |
|------|-----|------|
| unit | 1 | 单位为元 |
| tradeDate | 昨天日期 | 查询基准日期 |
| cycle | D | 日度数据 |
| priceAdj | U | 不复权 |
| days | -20 | 最近20天 |

### 字段对比

| 特性 | avg_amount_20d | amt_nd + days=-20 |
|------|----------------|-------------------|
| 字段类型 | 预计算指标 | 原始数据字段 |
| 灵活性 | 固定20天 | 可自定义天数 |
| 准确性 | 依赖Wind预计算 | 基于原始成交额 |
| 参数控制 | 简单 | 详细 |

## 应用位置

### 1. 基金成交额查询 ✅
```python
@shelve_me_week
def _fetch_etf_universe() -> pd.DataFrame:
    ...
    amt_data = w.wss(
        batch_codes,
        "amt_nd",
        f"unit=1;tradeDate={yesterday};cycle=D;priceAdj=U;days=-20"
    )
```

### 2. 可转债成交额查询 ✅
```python
@shelve_me_week
def _fetch_convertible_bond_universe() -> pd.DataFrame:
    ...
    info_data = w.wss(
        codes,
        "carryingvalue,amt_nd",
        f"unit=1;tradeDate={yesterday};cycle=D;priceAdj=U;days=-20"
    )
```

## 测试示例

```python
from WindPy import w
from datetime import datetime, timedelta

w.start()

# 获取昨天日期
yesterday = (datetime.now() - timedelta(days=1)).strftime('%Y%m%d')

# 测试查询
result = w.wss(
    "600009.SH,600015.SH", 
    "amt_nd",
    f"unit=1;tradeDate={yesterday};cycle=D;priceAdj=U;days=-20"
)

print(f"ErrorCode: {result.ErrorCode}")
print(f"Data: {result.Data}")
print(f"Fields: {result.Fields}")
```

## 数据说明

### amt_nd 字段
- **含义**: N日成交额（N-day Amount）
- **配合 days=-20**: 获取最近20个交易日的平均成交额
- **单位**: 元（通过 unit=1 指定）
- **输出**: 返回20日平均成交额的数值

### 数据处理

Wind API会自动处理并返回20日平均值，无需手动计算：

```python
# Wind API已自动计算平均值
avg_amounts.extend(amt_data.Data[0])  # 直接使用
```

## 优势分析

### 1. 更准确
- 基于原始成交额数据
- 参数透明，可控性强

### 2. 更灵活
- 可以自定义天数（days参数）
- 可以指定是否复权（priceAdj参数）

### 3. 更标准
- 符合Wind API规范用法
- 与其他查询参数保持一致

## 注意事项

⚠️ **装饰器用法提醒**

根据 shelveTool 文档，标准装饰器用法为：

```python
# ✅ 正确用法
@shelve_me_week
def my_function():
    pass

# ❌ 错误用法
@shelve_me_week(0)  # shelve_me_week 不接受参数
def my_function():
    pass

# ✅ 如需自定义，使用 shelve_it
@shelve_it('week', 'v1')
def my_function():
    pass
```

**建议修正**：
- 将 `@shelve_me_week(0)` 改为 `@shelve_me_week`
- 将 `@shelve_me_week(-1)` 改为 `@shelve_me_week`

## 验证

- ✅ 无linter错误
- ✅ 参数格式正确
- ✅ 字段使用准确
- ✅ 日志信息完整

---

**优化完成**：成交额查询现使用 amt_nd 字段，参数更标准 ✅

