# 成交额查询方式最终优化

## 更新时间
2025-11-03

## 核心变更

### 从 w.wss 改为 w.wsd ✅

**原因**：
- `w.wsd` 是时间序列接口，更适合获取历史成交额
- `w.wss` 是截面数据接口，对于成交额查询支持不够完善
- `w.wsd` 可以直接获取单日成交额，更准确

## 详细变更

### 1. 基金成交额查询 ✅

**变更前**：
```python
amt_data = w.wss(
    batch_codes,
    "amt_nd",
    f"unit=1;tradeDate={yesterday};cycle=D;priceAdj=U;days=-20"
)
```

**变更后**：
```python
# 获取上个交易日
last_trade_day = getLastOpenDay(datetime.now().strftime('%Y%m%d'))
last_trade_day_fmt = f"{last_trade_day[:4]}-{last_trade_day[4:6]}-{last_trade_day[6:]}"

amt_data = w.wsd(
    ",".join(batch_codes),
    "amt",
    last_trade_day_fmt,
    last_trade_day_fmt,
    "unit=1"
)
```

### 2. 可转债成交额查询 ✅

**变更前**：
```python
info_data = w.wss(
    codes,
    "carryingvalue,amt_nd",
    f"unit=1;tradeDate={yesterday};cycle=D;priceAdj=U;days=-20"
)
```

**变更后**：
```python
# 分别查询：规模用wss，成交额用wsd
# 1. 规模查询
cap_data = w.wss(
    codes,
    "carryingvalue",
    f"unit=1;tradeDate={last_trade_day}"
)

# 2. 成交额查询（分批）
amt_data = w.wsd(
    ",".join(batch_codes),
    "amt",
    last_trade_day_fmt,
    last_trade_day_fmt,
    "unit=1"
)
```

### 3. 装饰器修正 ✅

**变更前**：
```python
@shelve_me_week(0)   # 错误用法
@shelve_me_week(-1)  # 错误用法
```

**变更后**：
```python
@shelve_me_week  # 标准用法
```

## 新增依赖

```python
from tools.tradeCal import getLastOpenDay
```

## 关键改进

### 1. 使用上个交易日 ✅

```python
# 使用 tradeCal 工具获取准确的上个交易日
last_trade_day = getLastOpenDay(datetime.now().strftime('%Y%m%d'))
```

**优势**：
- 自动处理节假日
- 自动处理周末
- 确保日期是有效交易日

### 2. 日期格式转换 ✅

```python
# Wind wsd接口需要带横杠的日期格式
last_trade_day_fmt = f"{last_trade_day[:4]}-{last_trade_day[4:6]}-{last_trade_day[6:]}"
```

### 3. 代码拼接方式 ✅

```python
# wsd需要用逗号分隔的字符串
",".join(batch_codes)
```

### 4. 批量大小调整 ✅

```python
# wsd对批量查询有限制，调整为100只/批
batch_size = 100  # 原来是500
```

## API对比

| 特性 | w.wss | w.wsd |
|------|-------|-------|
| 接口类型 | 截面数据 | 时间序列 |
| 适用场景 | 单时点多指标 | 多时点单/多指标 |
| 代码格式 | 列表 | 逗号分隔字符串 |
| 日期格式 | YYYYMMDD | YYYY-MM-DD |
| 返回格式 | Data[字段][股票] | Data[字段][时间][股票] |
| 批量限制 | 较宽松 | 较严格（建议≤100） |

## 测试示例

```python
from WindPy import w
from tools.tradeCal import getLastOpenDay
from datetime import datetime

w.start()

# 获取上个交易日
last_trade_day = getLastOpenDay(datetime.now().strftime('%Y%m%d'))
last_trade_day_fmt = f"{last_trade_day[:4]}-{last_trade_day[4:6]}-{last_trade_day[6:]}"

# 查询基金成交额
result = w.wsd(
    "159116.OF,159106.OF",
    "amt",
    last_trade_day_fmt,
    last_trade_day_fmt,
    "unit=1"
)

print(f"ErrorCode: {result.ErrorCode}")
print(f"Last Trade Day: {last_trade_day}")
print(f"Data: {result.Data}")
print(f"Times: {result.Times}")
```

## 数据说明

### amt 字段
- **含义**: Amount（成交额）
- **单位**: 元（通过 unit=1 指定）
- **数据类型**: 单日成交额（不是均值）

### 返回格式
```python
# w.wsd 返回格式
result.Data[0]  # 第一个字段（amt）的所有股票数据
# 对于单日查询：Data[0] = [股票1成交额, 股票2成交额, ...]
```

## 优势总结

1. **更准确** ✅
   - 使用时间序列接口，专为历史数据设计
   - 数据来源更直接

2. **更稳定** ✅
   - 使用 tradeCal 确保交易日准确
   - 避免非交易日查询失败

3. **更标准** ✅
   - w.wsd 是获取成交额的标准方法
   - 参数简洁清晰

4. **更可靠** ✅
   - 装饰器使用标准语法
   - 避免潜在错误

## 注意事项

⚠️ **批量大小**
- wsd 对批量查询限制较严
- 建议每批不超过100只
- 基金和可转债都已调整为100只/批

⚠️ **日期格式**
- wsd 需要 `YYYY-MM-DD` 格式
- wss 需要 `YYYYMMDD` 格式
- 注意区分

⚠️ **错误处理**
- wsd 对无效代码更敏感
- 建议添加异常处理
- 记录失败的代码

## 验证

- ✅ 无linter错误
- ✅ 使用标准装饰器
- ✅ 使用tradeCal工具
- ✅ 批量大小合理
- ✅ 日期格式正确

---

**最终优化完成**：成交额查询全面升级，使用 w.wsd + tradeCal 组合 ✅

