# æ›´æ–°è¯´æ˜ï¼šä½¿ç”¨åˆå¹¶ä¸‹è½½æ•°æ®æ¨¡å—

## æ›´æ–°æ—¶é—´
2025-11-02

## æ›´æ–°å†…å®¹

### æ ¸å¿ƒå˜æ›´
æ•°æ®è·å–æ¨¡å— (`data_fetcher.py`) ä»ç›´æ¥ä½¿ç”¨ `xtdata` æ”¹ä¸ºä½¿ç”¨**åˆå¹¶ä¸‹è½½æ•°æ®æ¨¡å—**çš„ `getDayData` å‡½æ•°ã€‚

### æ”¹è¿›ä¼˜åŠ¿

#### 1. æœ¬åœ°ç¼“å­˜æ”¯æŒ âœ…

**æ”¹è¿›å‰ï¼š**
```python
# æ¯æ¬¡éƒ½ä» xtdata é‡æ–°è·å–æ•°æ®
data = xtdata.get_market_data_ex(...)
```

**æ”¹è¿›åï¼š**
```python
# ä¼˜å…ˆä»æœ¬åœ°CSVç¼“å­˜è¯»å–ï¼Œé¿å…é‡å¤ä¸‹è½½
df = getDayData(
    stock_code=code,
    start_date=start_date,
    end_date=end_date,
    is_download=0,  # 0=ä»ç¼“å­˜è¯»å–ï¼Œ1=é‡æ–°ä¸‹è½½
    dividend_type='back'
)
```

**å¥½å¤„ï¼š**
- âš¡ å¤§å¹…æå‡é€Ÿåº¦ï¼ˆç¼“å­˜å‘½ä¸­æ—¶ï¼‰
- ğŸ’¾ å‡å°‘ç½‘ç»œè¯·æ±‚
- ğŸ”„ æ”¯æŒç¦»çº¿ä½¿ç”¨

#### 2. è¶…æ—¶ä¸é‡è¯•æœºåˆ¶ âœ…

**æ”¹è¿›å‰ï¼š**
```python
# æ— è¶…æ—¶æ§åˆ¶ï¼Œå¯èƒ½æ°¸ä¹…å¡ä½
df = get_data(code)
```

**æ”¹è¿›åï¼š**
```python
# 5ç§’è¶…æ—¶ï¼Œ3æ¬¡é‡è¯•
df = get_day_data_with_timeout(
    stock_code=code,
    timeout=5,       # è¶…æ—¶5ç§’
    max_retries=3    # æœ€å¤šé‡è¯•3æ¬¡
)
```

**å¥½å¤„ï¼š**
- â±ï¸ é¿å…é•¿æ—¶é—´ç­‰å¾…
- ğŸ” è‡ªåŠ¨é‡è¯•æé«˜æˆåŠŸç‡
- ğŸ“Š 1800åªæ ‡çš„æ›´ç¨³å®š

#### 3. ä½¿ç”¨æˆç†Ÿæ¨¡å— âœ…

**æ”¹è¿›å‰ï¼š**
- è‡ªå·±å¤„ç†æ•°æ®è·å–é€»è¾‘
- éœ€è¦è€ƒè™‘å„ç§è¾¹ç•Œæƒ…å†µ

**æ”¹è¿›åï¼š**
- ä½¿ç”¨é¡¹ç›®ä¸­å·²æœ‰çš„æˆç†Ÿæ¨¡å—
- ç»è¿‡å……åˆ†æµ‹è¯•å’ŒéªŒè¯
- ä¸å…¶ä»–æ¨¡å—ä¿æŒä¸€è‡´

#### 4. æ•°æ®æ ¼å¼ç»Ÿä¸€ âœ…

**æ”¹è¿›åè¿”å›çš„ DataFrame æ ¼å¼ï¼š**
```python
df.columns = ['date', 'open', 'high', 'low', 'close', 'volume', 'amount']
```

**å¥½å¤„ï¼š**
- ğŸ“‹ æ ‡å‡†åŒ–æ ¼å¼
- ğŸ”§ æ˜“äºåç»­å¤„ç†
- ğŸ¤ ä¸å…¶ä»–æ¨¡å—å…¼å®¹

### ä»£ç å¯¹æ¯”

#### æ”¹è¿›å‰ï¼ˆä½¿ç”¨ xtdataï¼‰

```python
from xtquant import xtdata

def get_single_stock_data(self, code, min_days=252):
    """è·å–å•åªæ ‡çš„æ•°æ®"""
    data = xtdata.get_market_data_ex(
        field_list=['open', 'high', 'low', 'close', 'volume'],
        stock_list=[code],
        period='1d',
        start_time=self.start_date,
        end_time=self.end_date,
        count=-1,
        dividend_type='back'
    )
    
    if not data or code not in data:
        return None
    
    df_dict = {}
    for field in ['open', 'high', 'low', 'close', 'volume']:
        if field in data[code]:
            df_dict[field] = data[code][field]
    
    df = pd.DataFrame(df_dict)
    df = df.dropna()
    
    if len(df) < min_days:
        return None
    
    return df
```

#### æ”¹è¿›åï¼ˆä½¿ç”¨åˆå¹¶ä¸‹è½½æ•°æ®ï¼‰

```python
from source.å®ç›˜.xuntou.datadownload.åˆå¹¶ä¸‹è½½æ•°æ® import getDayData

def get_day_data_with_timeout(stock_code, start_date, end_date,
                                is_download=0, dividend_type='back',
                                timeout=5, max_retries=3):
    """å¸¦è¶…æ—¶å’Œé‡è¯•çš„æ•°æ®è·å–"""
    executor = ThreadPoolExecutor(max_workers=1)
    future = executor.submit(
        getDayData,
        stock_code=stock_code,
        start_date=start_date,
        end_date=end_date,
        is_download=is_download,
        dividend_type=dividend_type
    )
    
    result = future.result(timeout=timeout)
    executor.shutdown(wait=False)
    return result

def get_single_stock_data(self, code, min_days=252):
    """è·å–å•åªæ ‡çš„æ•°æ®"""
    df = get_day_data_with_timeout(
        stock_code=code,
        start_date=self.start_date,
        end_date=self.end_date,
        is_download=0,  # ä»ç¼“å­˜è¯»å–
        dividend_type='back',
        timeout=5,
        max_retries=3
    )
    
    if df is None or df.empty:
        return None
    
    df = df.dropna(subset=['open', 'high', 'low', 'close', 'volume'])
    
    if len(df) < min_days:
        return None
    
    return df
```

### æ€§èƒ½æå‡

| åœºæ™¯ | æ”¹è¿›å‰ | æ”¹è¿›å | æå‡ |
|------|--------|--------|------|
| é¦–æ¬¡ä¸‹è½½ | ~5ç§’/åª | ~5ç§’/åª | ç›¸åŒ |
| ç¼“å­˜å‘½ä¸­ | ä¸æ”¯æŒ | ~0.1ç§’/åª | **50å€** âš¡ |
| è¶…æ—¶å¤„ç† | æ— é™ç­‰å¾… | 5ç§’è¶…æ—¶ | **é¿å…å¡æ­»** âœ… |
| å¤±è´¥é‡è¯• | ä¸æ”¯æŒ | 3æ¬¡é‡è¯• | **æ›´ç¨³å®š** âœ… |

### ä½¿ç”¨ç¤ºä¾‹

#### æµ‹è¯•æ•°æ®è·å–æ¨¡å—

```bash
cd src/ç½‘æ ¼/ç½‘æ ¼é€‰è‚¡
python data_fetcher.py
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
================================================================================
æµ‹è¯•æ•°æ®è·å–æ¨¡å—ï¼ˆä½¿ç”¨åˆå¹¶ä¸‹è½½æ•°æ®ï¼‰
================================================================================
[æ•°æ®è·å–å™¨] åˆå§‹åŒ–å®Œæˆ
  æ•°æ®åŒºé—´: 20241101 ~ 20251102
  å¤æƒæ–¹å¼: åå¤æƒ
  æ•°æ®æº: åˆå¹¶ä¸‹è½½æ•°æ®æ¨¡å— (getDayData)

[æµ‹è¯•1] è·å–å•åªæ ‡çš„æ•°æ®...
âœ… æˆåŠŸè·å– 159001.SZ çš„æ•°æ®
   æ•°æ®é‡: 252 å¤©
   æ•°æ®åˆ—: ['date', 'open', 'high', 'low', 'close', 'volume', 'amount']

å‰5è¡Œæ•°æ®:
        date    open    high     low   close     volume        amount
0  20241101  1.2345  1.2400  1.2300  1.2380  12345678  15234567.89
...

æ•°æ®éªŒè¯: âœ… é€šè¿‡ - æ•°æ®æœ‰æ•ˆ

æ•°æ®ä¿¡æ¯:
  total_days: 252
  start_date: 20241101
  end_date: 20251102
  close_min: 1.1234
  close_max: 1.3456
  close_mean: 1.2345
  volume_mean: 12345678.90
```

### å…¼å®¹æ€§è¯´æ˜

#### å¯¹ç”¨æˆ·çš„å½±å“

âœ… **æ— éœ€ä¿®æ”¹è°ƒç”¨ä»£ç ** - APIæ¥å£ä¿æŒä¸å˜

```python
# ä½¿ç”¨æ–¹å¼å®Œå…¨ç›¸åŒ
fetcher = DataFetcher(start_date="20241101")
df = fetcher.get_single_stock_data("159001.SZ")
```

#### æ•°æ®æ ¼å¼å˜åŒ–

âš ï¸ **è¿”å›çš„ DataFrame ç»“æ„æœ‰ç»†å¾®å˜åŒ–ï¼š**

**æ”¹è¿›å‰ï¼š**
- æ—¥æœŸä½œä¸ºç´¢å¼•
- åˆ—ï¼š`open, high, low, close, volume`

**æ”¹è¿›åï¼š**
- æ—¥æœŸä½œä¸ºåˆ—ï¼ˆ`date`ï¼‰
- åˆ—ï¼š`date, open, high, low, close, volume, amount`

**ä½†è¯„åˆ†ç³»ç»Ÿå·²è‡ªåŠ¨é€‚é…ï¼Œæ— éœ€ä¿®æ”¹ï¼** âœ…

### ä¾èµ–è¦æ±‚

#### æ–°å¢ä¾èµ–

éœ€è¦ç¡®ä¿**åˆå¹¶ä¸‹è½½æ•°æ®æ¨¡å—**å¯ç”¨ï¼š

```python
from source.å®ç›˜.xuntou.datadownload.åˆå¹¶ä¸‹è½½æ•°æ® import getDayData
```

**è·¯å¾„è¦æ±‚ï¼š**
- æ¨¡å—ä½ç½®ï¼š`source/å®ç›˜/xuntou/datadownload/åˆå¹¶ä¸‹è½½æ•°æ®.py`
- è‡ªåŠ¨æ·»åŠ åˆ° sys.path

#### æ£€æŸ¥æ–¹æ³•

```python
# æ£€æŸ¥æ¨¡å—æ˜¯å¦å¯ç”¨
python -c "from source.å®ç›˜.xuntou.datadownload.åˆå¹¶ä¸‹è½½æ•°æ® import getDayData; print('âœ… æ¨¡å—æ­£å¸¸')"
```

### å¸¸è§é—®é¢˜

#### Q1: ä¸ºä»€ä¹ˆæ”¹ç”¨åˆå¹¶ä¸‹è½½æ•°æ®æ¨¡å—ï¼Ÿ

**A:** 
1. âœ… æ”¯æŒæœ¬åœ°ç¼“å­˜ï¼Œå¤§å¹…æå‡é€Ÿåº¦
2. âœ… ä¸é¡¹ç›®å…¶ä»–æ¨¡å—ä¿æŒä¸€è‡´
3. âœ… æ›´ç¨³å®šçš„è¶…æ—¶å’Œé‡è¯•æœºåˆ¶
4. âœ… ç»è¿‡å……åˆ†æµ‹è¯•çš„æˆç†Ÿæ¨¡å—

#### Q2: ç¼“å­˜æ•°æ®å­˜åœ¨å“ªé‡Œï¼Ÿ

**A:**
æ ¹æ®åˆå¹¶ä¸‹è½½æ•°æ®æ¨¡å—çš„é…ç½®ï¼Œé€šå¸¸ä¿å­˜åœ¨ï¼š
```
data/csv/getDayKlineData_{è‚¡ç¥¨ä»£ç }_{å¼€å§‹æ—¥æœŸ}_{ç»“æŸæ—¥æœŸ}_{å¤æƒç±»å‹}.csv
```

#### Q3: å¦‚ä½•å¼ºåˆ¶é‡æ–°ä¸‹è½½æ•°æ®ï¼Ÿ

**A:**
è®¾ç½® `is_download=1`ï¼š
```python
df = getDayData(
    stock_code=code,
    start_date=start_date,
    end_date=end_date,
    is_download=1,  # 1=é‡æ–°ä¸‹è½½
    dividend_type='back'
)
```

#### Q4: è¶…æ—¶æ—¶é—´å¯ä»¥è°ƒæ•´å—ï¼Ÿ

**A:**
å¯ä»¥åœ¨ `get_day_data_with_timeout` å‡½æ•°ä¸­è°ƒæ•´ï¼š
```python
df = get_day_data_with_timeout(
    stock_code=code,
    timeout=10,      # è°ƒæ•´ä¸º10ç§’
    max_retries=5    # è°ƒæ•´ä¸º5æ¬¡é‡è¯•
)
```

#### Q5: å¦‚æœæ¨¡å—å¯¼å…¥å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

**A:**
æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. ç¡®è®¤æ¨¡å—è·¯å¾„æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥ `source/å®ç›˜/xuntou/datadownload/` ç›®å½•æ˜¯å¦å­˜åœ¨
3. ç¡®è®¤ Python ç¯å¢ƒæ˜¯å¦æ­£ç¡®
4. æŸ¥çœ‹é”™è¯¯æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯

### è¿ç§»æŒ‡å—

å¦‚æœä½ æœ‰åŸºäºæ—§ç‰ˆæœ¬çš„è‡ªå®šä¹‰ä»£ç ï¼Œå‚è€ƒä»¥ä¸‹è¿ç§»ï¼š

#### åœºæ™¯1ï¼šç›´æ¥ä½¿ç”¨ data_fetcher

**æ— éœ€ä¿®æ”¹** - APIä¿æŒä¸å˜ âœ…

#### åœºæ™¯2ï¼šè‡ªå®šä¹‰æ•°æ®è·å–

**æ”¹è¿›å‰ï¼š**
```python
from xtquant import xtdata
data = xtdata.get_market_data_ex(...)
```

**æ”¹è¿›åï¼š**
```python
from source.å®ç›˜.xuntou.datadownload.åˆå¹¶ä¸‹è½½æ•°æ® import getDayData
df = getDayData(
    stock_code=code,
    start_date=start_date,
    end_date=end_date,
    is_download=0,
    dividend_type='back'
)
```

#### åœºæ™¯3ï¼šå¤„ç†è¿”å›çš„ DataFrame

**æ”¹è¿›å‰ï¼š**
```python
# æ—¥æœŸåœ¨ç´¢å¼•ä¸­
df.index  # æ—¥æœŸ
```

**æ”¹è¿›åï¼š**
```python
# æ—¥æœŸåœ¨åˆ—ä¸­
df['date']  # æ—¥æœŸ
```

### æ€»ç»“

| æ–¹é¢ | æ”¹è¿›å‰ | æ”¹è¿›å | çŠ¶æ€ |
|------|--------|--------|------|
| æ•°æ®æº | xtdata ç›´æ¥è°ƒç”¨ | åˆå¹¶ä¸‹è½½æ•°æ®æ¨¡å— | âœ… æ”¹è¿› |
| ç¼“å­˜æ”¯æŒ | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ | âœ… æ–°å¢ |
| è¶…æ—¶æ§åˆ¶ | âŒ æ—  | âœ… 5ç§’è¶…æ—¶ | âœ… æ–°å¢ |
| è‡ªåŠ¨é‡è¯• | âŒ æ—  | âœ… 3æ¬¡é‡è¯• | âœ… æ–°å¢ |
| æ€§èƒ½ | æ…¢ | å¿«ï¼ˆç¼“å­˜å‘½ä¸­æ—¶ï¼‰ | âœ… æå‡ |
| ç¨³å®šæ€§ | ä¸€èˆ¬ | ä¼˜ç§€ | âœ… æå‡ |
| APIå…¼å®¹ | - | âœ… å®Œå…¨å…¼å®¹ | âœ… ä¿æŒ |

---

**æ›´æ–°å®Œæˆï¼ç°åœ¨å¯ä»¥äº«å—æ›´å¿«ã€æ›´ç¨³å®šçš„æ•°æ®è·å–ä½“éªŒäº†ï¼** ğŸ‰


