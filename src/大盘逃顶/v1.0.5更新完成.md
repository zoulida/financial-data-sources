# v1.0.5 更新完成总结

## ✅ 更新内容

### 1. 融资余额评分规则优化 ⭐

**变更前 (v1.0.4)**:
- 3日全为负 → 1.0分
- 2日为负 → 0.4分
- 其他 → 0分

**变更后 (v1.0.5)**:
- 3日全为负 → **1.0分**
- 2日为负 → **0.4分**
- **1日为负 → 0.2分** ⭐ 新增
- 其他 → 0分

**优势**:
- ✅ 更精细的风险分级
- ✅ 单日异常也能捕捉
- ✅ 提高预警敏感度

### 2. 量价背离数据源优化 ⭐⭐

**变更前 (v1.0.4)**:
- 使用 `xtdata.get_market_data_ex()` 直接获取
- akshare 作为备用

**变更后 (v1.0.5)**:
- ✅ 改用标准 `getDayData` 接口
- ✅ 利用项目数据缓存机制
- ✅ **移除 akshare 备用方案**
- ✅ 显示具体背离日期和萎缩幅度

**代码示例**:
```python
from 合并下载数据 import getDayData

# 获取上证指数最近30天数据
df = getDayData(
    stock_code='000001.SH',
    start_date=start_date,
    end_date=end_date,
    is_download=0,  # 优先缓存
    dividend_type='none'
)

# 检查量价背离
divergence_days = 0
for i in range(1, 6):
    price_up = df.iloc[i]['close'] > df.iloc[i-1]['close']
    volume_shrink_rate = (df.iloc[i-1]['volume'] - df.iloc[i]['volume']) / df.iloc[i-1]['volume']
    
    if price_up and volume_shrink_rate >= 0.20:
        divergence_days += 1
```

**优势**:
- 数据源统一，易维护
- 本地缓存，速度更快
- 减少外部依赖
- 更详细的日志输出

### 3. 改进错误提示

**新增提示信息**:
- ✅ XtQuant 数据不足时显示当前数据条数
- ✅ 量价背离时显示具体日期和萎缩幅度
- ✅ 所有数据源失败时统一显示 "⚠ 无法获取xxx数据，默认得分: 0.00"

**示例输出**:
```
[3/4] 正在获取量价背离数据...
  ✓ XtQuant数据：最近5日发现 2 日量价背离，得分: 1.50
    背离日期: 2025-10-18 (量缩24.3%), 2025-10-19 (量缩32.1%)
```

## 📊 数据源最终方案 (v1.0.5)

| 指标 | 数据源 | 接口/方法 | 备用方案 | 状态 |
|------|--------|----------|---------|------|
| 融资余额 | Wind API | `w.wset` | 东方财富网 | ✅ 双重保障 |
| **开户数** | **Wind API** | **`w.edb` M0010401** | **无** | ⭐ 唯一来源 |
| **量价背离** | **XtQuant** | **`getDayData`** | **无** | ⭐ 新优化 |
| 估值百分位 | akshare | `index_value_name_em` | 无 | ✅ 保留 |

### 数据源依赖说明

1. **Wind API (必需)**:
   - 融资余额（优先）
   - 开户数（唯一来源）

2. **XtQuant (必需)**:
   - 量价背离（唯一来源）
   - 通过 `getDayData` 获取日K线

3. **akshare (仅估值)**:
   - 估值百分位（唯一来源）
   - 其他指标已移除 akshare

4. **东方财富网 (备用)**:
   - 融资余额（Wind失败时）

## 🎯 评分规则总览 (v1.0.5)

### 总分范围：0-4.5分

| 指标 | 分值范围 | 权重 | 数据源 |
|------|---------|------|--------|
| 融资余额 | 0-1.0 | 22% | Wind / 东财 |
| **开户数** | **0-1.5** | **33%** | Wind ⭐ |
| 量价背离 | 0-1.0+ | 22%+ | XtQuant |
| 估值百分位 | 0-1.0 | 22% | akshare |

### 逃顶阈值

- **≥2.2分**: 🚨 强烈逃顶信号
- **≥3.0分**: 🚨🚨 极度危险
- **<2.2分**: ✅ 暂无明显信号

## 📁 新增文件

1. **融资余额评分测试.py**
   - 测试融资余额评分规则
   - 对比新旧规则差异
   - 实际场景示例

2. **测试量价背离.py**
   - 诊断量价背离数据获取
   - 测试 XtQuant 和 akshare
   - 详细的数据展示

## 🧪 测试验证

### 1. 测试融资余额评分规则

```bash
python 融资余额评分测试.py
```

**预期输出**:
```
融资余额评分规则测试 (v1.0.5)
======================================================================

测试结果:
案例                | 数据(亿元)                      | 负日数   | 预期    | 实际    | 结果
----------------------------------------------------------------------------------------
3日全为负           | -100, -50, -80                  |        3 |     1.0 |     1.0 | ✓ 通过
2日为负             | -100, +50, -80                  |        2 |     0.4 |     0.4 | ✓ 通过
1日为负             | -100, +50, +80                  |        1 |     0.2 |     0.2 | ✓ 通过
全部为正            | +100, +50, +80                  |        0 |     0.0 |     0.0 | ✓ 通过
```

### 2. 运行主程序

```bash
cd src/大盘逃顶
python escape_top_scorer.py
```

**预期输出**:
```
======================================================================
A股牛市逃顶打分器 v1.0.5
运行时间: 2025-10-20 20:30:00
======================================================================

[1/4] 正在获取融资余额数据...
  ✓ Wind数据：最近3日融资净买入情况正常，得分: 0.0
    数据: ['+123.45亿', '+89.67亿', '+45.23亿']

[2/4] 正在获取开户数数据...
  ✓ Wind数据：2025-09(158.32万) → 2025-10(162.45万)
    环比变化: +2.6% (降幅: -2.6%)
    得分: 0.00

[3/4] 正在获取量价背离数据...
  ✓ XtQuant数据：最近5日发现 0 日量价背离，得分: 0.00

[4/4] 正在获取估值百分位数据...
  ✓ akshare数据：PE-TTM百分位 65.2%，得分: 0.00

======================================================================
2025-10-20 逃顶打分
融资余额: 0.0 | 开户数: 0.0 | 量价背离: 0.0 | 估值百分位: 0.0
总分: 0.0/4.5
【✓ 暂无明显逃顶信号】
======================================================================
```

## 🔄 从 v1.0.4 升级到 v1.0.5

### 代码变更

1. **融资余额评分**
   ```python
   # 新增1日为负的情况
   elif negative_days == 1:
       score = 0.2
   ```

2. **量价背离数据获取**
   ```python
   # 旧代码（已删除）
   # from xtquant import xtdata
   # data = xtdata.get_market_data_ex(...)
   
   # 新代码
   from 合并下载数据 import getDayData
   df = getDayData(
       stock_code='000001.SH',
       start_date=start_date,
       end_date=end_date,
       is_download=0,
       dividend_type='none'
   )
   ```

### 依赖变化

**不变**:
- 仍需要 Wind 终端
- 仍需要 XtQuant
- 仍需要 akshare（仅估值）

**优化**:
- 利用项目现有的 `合并下载数据.py` 模块
- 减少了重复代码
- 统一了数据获取方式

### 配置文件

**无需修改**，所有变更都在代码层面。

## ⚠️ 重要提示

### 1. 必需依赖

- **Wind 终端**: 必须安装并登录
- **XtQuant**: 必须安装
- **合并下载数据.py**: 必须在 `source/实盘/xuntou/datadownload/` 目录

### 2. 数据更新时机

- **融资余额**: 每个交易日盘后更新
- **开户数**: 每月15日前后更新上月数据
- **量价背离**: 实时数据，依赖XtQuant连接
- **估值百分位**: 每日更新

### 3. 建议运行时间

- **每日盘后 16:00-17:00** 运行主程序
- 确保 Wind 和 XtQuant 已连接

## 📝 版本对比

| 版本 | 融资余额规则 | 量价背离数据源 | akshare使用 | 总分范围 |
|------|-------------|---------------|------------|---------|
| v1.0.4 | 3级评分 | XtQuant API → akshare | 开户/量价/估值 | 0-4.5 |
| v1.0.5 | 4级评分 | getDayData | 仅估值 | 0-4.5 |

## 🎉 总结

**v1.0.5 是一个重要的优化版本**:

✅ **优势**:
- 评分更精细（融资余额4级）
- 数据源更统一（使用标准接口）
- 代码更简洁（减少重复）
- 日志更详细（显示具体数据）

⚠️ **注意**:
- 必须有 `合并下载数据.py` 模块
- Wind 终端必须运行
- XtQuant 必须连接

🚀 **推荐升级**:
- 所有用户建议升级到 v1.0.5
- 数据获取更稳定
- 风险预警更敏感

---

**更新完成时间**: 2025-10-20  
**版本**: v1.0.5  
**状态**: ✅ 稳定版本  
**下一版本计划**: v1.1.0（新增更多指标）

