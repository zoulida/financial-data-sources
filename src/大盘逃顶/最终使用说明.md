# A股牛市逃顶打分器 - 最终使用说明 (v1.0.5)

## 📋 快速开始

### 1. 环境要求

**必需软件**:
- ✅ Python 3.8+
- ✅ Wind 终端（已安装并登录）
- ✅ XtQuant（国金QMT）

**必需文件**:
- ✅ `source/实盘/xuntou/datadownload/合并下载数据.py` - 数据下载模块

### 2. 安装依赖

```bash
pip install WindPy xtquant pandas matplotlib requests akshare
```

### 3. 运行程序

```bash
# 从项目根目录运行
python src/大盘逃顶/escape_top_scorer.py
```

## 📊 评分规则 (v1.0.5)

### 总分范围：0-4.5分

| 指标 | 分值范围 | 规则 | 数据源 |
|------|---------|------|--------|
| 融资余额 | 0-1.0 | 3日负(1分) / 2日负(0.4分) / **1日负(0.2分)** ⭐ | Wind → 东财 |
| 开户数 | 0-1.5 | 环比降≥30%(1.5分) / 线性插值 | Wind API |
| 量价背离 | 0-1.0+ | 1日(1分) / 2日(1.5分) / 3日+(2分+) | **XtQuant (getDayData)** ⭐ |
| 估值百分位 | 0-1.0 | ≥95%(1分) / ≤80%(0分) / 线性插值 | akshare |

### 逃顶阈值

- **≥2.2分**: 🚨 强烈逃顶信号
- **≥3.0分**: 🚨🚨 极度危险
- **<2.2分**: ✅ 暂无明显信号

## 🔍 v1.0.5 核心变更

### 1. 融资余额评分更精细 ⭐

**新增**: 1日为负 → 0.2分

**完整规则**:
```
3日全为负 → 1.0分  (最高风险)
2日为负   → 0.4分  (中度风险)
1日为负   → 0.2分  (轻度风险) ⭐ 新增
其他情况  → 0.0分  (正常)
```

### 2. 量价背离数据源优化 ⭐⭐

**变更前 (v1.0.4)**:
```python
# 直接调用 xtdata API
from xtquant import xtdata
data = xtdata.get_market_data_ex(...)
# + akshare 备用
```

**变更后 (v1.0.5)**:
```python
# 使用标准数据模块
from 合并下载数据 import getDayData
df = getDayData(
    stock_code='000001.SH',
    start_date=start_date,
    end_date=end_date,
    is_download=0,  # 优先缓存
    dividend_type='none'
)
# ✅ 移除 akshare 备用
```

**优势**:
- ✅ 统一数据接口
- ✅ 利用本地缓存
- ✅ 减少外部依赖
- ✅ 显示详细背离信息

## 📁 项目结构

```
数据源/
├── src/大盘逃顶/
│   ├── escape_top_scorer.py          ⭐ 主程序 (v1.0.5)
│   ├── README.md                     项目说明
│   ├── 更新日志.md                   版本更新记录
│   ├── v1.0.5更新完成.md             本次更新总结
│   ├── 最终使用说明.md               本文档
│   ├── 融资余额评分测试.py           评分规则测试
│   ├── 测试Wind融资余额.py           Wind API测试
│   ├── 测试Wind开户数据.py           开户数据测试
│   ├── 测试量价背离.py               量价背离测试
│   ├── escape_top_history.csv        历史数据
│   └── escape_top_chart.png          趋势图
│
└── source/实盘/xuntou/datadownload/
    └── 合并下载数据.py                ⭐ 数据模块（必需）
```

## 🎯 典型输出示例

### 正常市场（无逃顶信号）

```
======================================================================
A股牛市逃顶打分器
运行时间: 2025-10-20 16:30:00
======================================================================

[1/4] 正在获取融资余额数据...
  ✓ Wind数据：最近3日融资净买入情况正常，得分: 0.0
    数据: ['+123.45亿', '+89.67亿', '+45.23亿']

[2/4] 正在获取开户数数据...
  ✓ Wind数据：2025-09(158.32万) → 2025-10(162.45万)
    环比变化: +2.6% (降幅: -2.6%)
    得分: 0.00

[3/4] 正在获取量价背离数据...
  ✓ XtQuant数据：最近5日发现 0 日量价背离，得分: 0.00

[4/4] 正在获取估值百分位数据...
  ✓ akshare数据：PE-TTM百分位 65.2%，得分: 0.00

======================================================================
2025-10-20 逃顶打分
融资余额: 0.0 | 开户数: 0.0 | 量价背离: 0.0 | 估值百分位: 0.0
总分: 0.0/4.5
【✓ 暂无明显逃顶信号】
======================================================================
```

### 牛市顶部（强烈逃顶信号）

```
======================================================================
A股牛市逃顶打分器
运行时间: 2025-10-20 16:30:00
======================================================================

[1/4] 正在获取融资余额数据...
  ✓ Wind数据：最近3日融资净买入全为负，得分: 1.0
    数据: ['-200.15亿', '-150.32亿', '-180.67亿']

[2/4] 正在获取开户数数据...
  ✓ Wind数据：2025-08(250.45万) → 2025-09(165.23万)
    环比变化: -34.0% (降幅: 34.0%)
    得分: 1.50

[3/4] 正在获取量价背离数据...
  ✓ XtQuant数据：最近5日发现 2 日量价背离，得分: 1.50
    背离日期: 2025-10-18 (量缩24.3%), 2025-10-19 (量缩32.1%)

[4/4] 正在获取估值百分位数据...
  ✓ akshare数据：PE-TTM百分位 98.5%，得分: 1.00

======================================================================
2025-10-20 逃顶打分
融资余额: 1.0 | 开户数: 1.5 | 量价背离: 1.5 | 估值百分位: 1.0
总分: 5.0/4.5
🚨🚨 强烈逃顶信号！建议立即减仓！
======================================================================
```

## 🧪 测试工具

### 1. 测试融资余额评分规则

```bash
python src/大盘逃顶/融资余额评分测试.py
```

### 2. 测试 Wind API 数据获取

```bash
# 测试融资余额
python src/大盘逃顶/测试Wind融资余额.py

# 测试开户数
python src/大盘逃顶/测试Wind开户数据.py
```

### 3. 测试量价背离数据获取

```bash
python src/大盘逃顶/测试量价背离.py
```

## ⚠️ 常见问题

### 1. "No module named '合并下载数据'"

**原因**: 数据模块路径不正确

**解决**:
- 确保 `source/实盘/xuntou/datadownload/合并下载数据.py` 存在
- 从项目根目录 (`D:\pythonProject\数据源`) 运行程序

### 2. "Wind API 连接失败"

**原因**: Wind 终端未运行或未登录

**解决**:
- 打开 Wind 终端
- 确保已登录
- 等待数据加载完成后再运行程序

### 3. "XtQuant 连接失败"

**原因**: QMT 未运行或未连接

**解决**:
- 打开国金 QMT 客户端
- 确保已登录
- 等待连接成功后再运行

### 4. "量价背离显示 0 分但无详细信息"

**可能原因**:
- 数据获取失败
- 数据不足（非交易日）
- 近期确实无量价背离

**检查方法**:
```bash
python src/大盘逃顶/测试量价背离.py
```

## 📈 使用建议

### 1. 运行时机

**推荐时间**: 每个交易日 **16:00-17:00**

**原因**:
- 当日行情已结束
- 融资余额数据已更新
- Wind 和 XtQuant 数据已同步

### 2. 数据时效性

| 指标 | 更新频率 | 延迟 |
|------|---------|------|
| 融资余额 | 每日 | ~1小时 |
| 开户数 | 每月 | 15日左右 |
| 量价背离 | 实时 | 无 |
| 估值百分位 | 每日 | ~1小时 |

### 3. 阈值调整建议

**保守型** (风险厌恶):
- 逃顶阈值：≥2.0分

**稳健型** (推荐):
- 逃顶阈值：≥2.2分

**激进型** (追求收益):
- 逃顶阈值：≥2.5分

### 4. 配合其他指标

建议结合:
- 北向资金流向
- 两融占比
- 个股涨停板数量
- 成交额放大倍数

## 📝 版本历史

| 版本 | 日期 | 主要变更 |
|------|------|---------|
| v1.0.5 | 2025-10-20 | 融资余额4级评分 / 量价背离用getDayData / 移除akshare备用 |
| v1.0.4 | 2025-10-20 | 开户数仅用Wind / 移除akshare备用 |
| v1.0.3 | 2025-10-20 | 开户数满分1.5 / 优先akshare |
| v1.0.2 | 2025-10-20 | Wind API修复 / 融资余额用wset |
| v1.0.1 | 2025-10-20 | 初始版本 |

## 🚀 未来计划

### v1.1.0（计划中）
- [ ] 添加北向资金指标
- [ ] 添加两融占比指标
- [ ] 支持个股逃顶分析
- [ ] 历史回测功能

### v1.2.0（计划中）
- [ ] Web 界面
- [ ] 邮件/微信通知
- [ ] 实时监控模式

### v2.0.0（远期）
- [ ] 机器学习模型
- [ ] 多市场支持（港股/美股）
- [ ] 策略回测框架

## 📞 技术支持

如有问题，请查看:
1. `README.md` - 项目说明
2. `更新日志.md` - 版本更新记录
3. `v1.0.5更新完成.md` - 最新变更详情
4. 运行测试脚本进行诊断

---

**当前版本**: v1.0.5  
**发布日期**: 2025-10-20  
**状态**: ✅ 稳定版本  
**推荐使用**: 是

