# A股牛市逃顶打分器

## 📊 功能介绍

每天收盘后自动运行，基于4个核心指标对A股市场进行逃顶风险评估：

1. **融资余额** (0-1分) - 监测融资净买入情况
2. **开户数** (0-1分) - 监测新增投资者变化  
3. **量价背离** (0-1分+) - 监测上证指数价量关系
4. **估值百分位** (0-1分) - 监测市场估值水平

**逃顶信号**: 总分 ≥ 2.2分时发出强烈警告

## 🚀 快速开始

### 版本说明

提供两个版本供选择：

1. **完整版** (`escape_top_scorer.py`)
   - 优先使用Wind API和XtQuant获取数据
   - 数据更准确、更及时
   - 需要安装Wind终端或XtQuant

2. **简化版** (`escape_top_scorer_simple.py`) ⭐ **推荐新手使用**
   - 仅使用akshare和东方财富网API
   - 无需额外配置，开箱即用
   - 适合快速测试和日常使用

### 安装依赖

```bash
# 进入项目目录
cd src/大盘逃顶

# 安装依赖包
pip install -r requirements.txt

# 或者手动安装
pip install pandas numpy matplotlib requests beautifulsoup4 akshare
```

### 运行程序

#### 方式1：使用快速启动脚本（推荐）

Windows：双击 `run.bat`

Linux/Mac：
```bash
chmod +x run.sh
./run.sh
```

#### 方式2：直接运行Python脚本

```bash
# 简化版（推荐）
python escape_top_scorer_simple.py

# 完整版（需要配置数据源）
python escape_top_scorer.py
```

## 📈 评分规则详解

**总分范围**: 0-8.5分（融资1分 + 开户1.5分 + 量价背离5分 + 估值1分）  
**逃顶阈值**: ≥2.2分（基础）/ ≥3.0分（强烈）/ ≥4.0分（极度危险）

### 1. 融资余额 (0-1分)

**数据源**: Wind API → 东方财富网

**规则**:
- 最近3日融资净买入全为负 → **1.0分**
- 最近3日有2日为负 → **0.4分**
- 最近3日有1日为负 → **0.2分**
- 其他情况 → **0分**

**含义**: 融资盘持续卖出，市场情绪转冷

### 2. 开户数 (0-1.5分)

**数据源**: akshare → Wind API

**规则**:
- 环比降幅 ≥ 30% → **1.5分**
- 环比降幅 = 0% → **0分**
- 环比降幅 0-30% → **线性插值**

**含义**: 新增投资者大幅减少，增量资金枯竭

### 3. 量价背离 (0-5分)

**数据源**: XtQuant (`getDayData`)

**规则**:
- 检查最近5个交易日
- 每日"收盘上涨 & 成交量萎缩≥5%" → 按萎缩幅度计分
  - **萎缩5%** → **0.2分**
  - **萎缩20%** → **1.0分**
  - **萎缩5%-20%之间** → **按比例线性插值**
  - **多日得分求和**

**计分公式**:
```
萎缩率 < 5%: 0分
萎缩率 = 5%: 0.2分
萎缩率 5%-20%: 0.2 + (萎缩率-5%)/(20%-5%) * 0.8
萎缩率 ≥ 20%: 1.0分
```

**含义**: 价格上涨但成交量萎缩，上涨动能不足

### 4. 估值百分位 (0-1分)

**数据源**: Wind API (Wind全A指数 881001.WI)

**规则**:
- Wind全A指数PE在近5年的百分位
  - 百分位 ≥ 95% → **1.0分**
  - 百分位 ≤ 60% → **0分**
  - 百分位 60-95% → **线性插值**

**计分公式**:
```
百分位 < 60%:  0分
百分位 = 60%:  0分  
百分位 60%-95%: (百分位-60%)/(95%-60%)
百分位 ≥ 95%:  1分
```

**含义**: 市场估值处于历史高位，泡沫风险增加

## 📁 输出文件

### 1. escape_top_history.csv
历史评分记录，包含每日各项指标得分

### 2. escape_top_chart.png
近3个月总分趋势图，直观展示逃顶风险变化

## 🎯 使用建议

### 信号解读

- **总分 < 1.0**: 市场处于相对安全区域
- **总分 1.0-2.0**: 市场有一定风险，需要关注
- **总分 2.0-2.2**: 市场风险较高，建议警惕
- **总分 ≥ 2.2**: 🚨 **强烈逃顶信号！建议减仓**
- **总分 ≥ 3.0**: 🚨🚨 **极度危险！建议大幅减仓或清仓**

### 注意事项

1. 本工具为辅助决策工具，不构成投资建议
2. 建议结合其他技术指标和基本面分析
3. 市场情况复杂，信号可能滞后或误判
4. 建议每日收盘后运行，保持数据更新

## 🔧 配置说明

### Wind API配置

如果安装了Wind终端，程序会优先使用Wind API获取数据：

```python
import WindPy as w
w.start()  # 需要Wind终端在后台运行
```

### XtQuant配置

如果安装了XtQuant，需要先配置token：

```python
from xtquant import xtdata
xtdata.set_token('your_token_here')
```

### 数据源

1. **融资余额**: Wind API (`w.wset`) → 东方财富网API
2. **开户数**: Wind API (`w.edb` M0010401) 
3. **量价背离**: XtQuant → akshare
4. **估值百分位**: akshare

## 📊 示例输出

```
======================================================================
A股牛市逃顶打分器
运行时间: 2025-10-20 16:30:00
======================================================================

[1/4] 正在获取融资余额数据...
  ✓ 东财数据：最近3日融资净买入全为负，得分: 1.0

[2/4] 正在获取开户数数据...
  ✓ akshare数据：环比降幅 15.2%，得分: 0.5

[3/4] 正在获取量价背离数据...
  ✓ akshare数据：发现 2 日量价背离，得分: 1.5

[4/4] 正在获取估值百分位数据...
  ✓ akshare数据：PE-TTM百分位 88.5%，得分: 0.6

======================================================================
2025-10-20 逃顶打分
融资余额: 1.0 | 开户数: 0.5 | 量价背离: 1.5 | 估值百分位: 0.6
总分: 3.6/4
【⚠️  强烈逃顶信号！】
======================================================================

✓ 历史数据已保存到: D:\pythonProject\数据源\src\大盘逃顶\escape_top_history.csv
✓ 趋势图已保存到: D:\pythonProject\数据源\src\大盘逃顶\escape_top_chart.png
```

## 📅 自动运行

### Windows 任务计划

1. 打开"任务计划程序"
2. 创建基本任务，设置每日15:30运行
3. 操作：启动程序
4. 程序/脚本：`python.exe`
5. 参数：`escape_top_scorer.py`
6. 起始于：`D:\pythonProject\数据源\src\大盘逃顶`

### Linux/Mac crontab

```bash
30 15 * * 1-5 cd /path/to/数据源/src/大盘逃顶 && python escape_top_scorer.py
```

## 🤝 贡献

欢迎提交Issue和Pull Request来改进这个工具！

## 📄 许可

MIT License

