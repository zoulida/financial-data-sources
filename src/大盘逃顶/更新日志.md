# 更新日志

## 2025-10-20 更新 v1.0.6

### 🔄 量价背离评分规则重构 ⭐⭐⭐

#### 1. 分级计分制度（按萎缩幅度比例计分）

**变更前 (v1.0.5)**:
- 只有萎缩≥20%才计分
- 1日记1分，2日记1.5分，3日+继续加0.5分
- 阶梯式加分

**变更后 (v1.0.6)**:
- ✅ 萎缩≥5%就开始计分
- ✅ 萎缩5% → **0.2分**
- ✅ 萎缩20% → **1.0分**
- ✅ 萎缩5%-20%之间 → **按比例线性插值**
- ✅ **多日得分求和**

**计分公式**:
```python
# 每日独立计分
for 每日 in 最近5日:
    if 收盘涨 and 量缩率 >= 20%:
        得分 += 1.0
    elif 收盘涨 and 量缩率 >= 5%:
        得分 += 0.2 + (量缩率-0.05)/0.15 * 0.8
    # 5%以下不计分

# 总得分 = 各日得分求和
```

**优势**:
- 更早捕捉风险信号（5% vs 20%）
- 更精细的分级（连续计分 vs 阶梯计分）
- 更合理的累计方式（求和 vs 固定加分）
- 分数范围更大（0-5分 vs 0-3分）

**示例对比**:

| 场景 | 5日萎缩情况 | v1.0.5得分 | v1.0.6得分 | 差异 |
|------|------------|-----------|-----------|------|
| 轻度背离 | 3日萎缩10% | 0分 | **1.40分** ⭐ | +1.40 |
| 中度背离 | 2日萎缩15%，1日萎缩25% | 1.5分 | **2.47分** | +0.97 |
| 重度背离 | 3日萎缩25% | 2.0分 | **3.00分** | +1.00 |
| 实际案例 | 19.5%, 7.7%, 11.1% | 1.0分 | **1.84分** | +0.84 |

#### 2. 详细日志输出

**新增输出内容**:
- 显示每日具体得分
- 显示背离详情（日期 + 萎缩率 + 单日得分）

**输出示例**:
```
[3/4] 正在获取量价背离数据...
  ✓ XtQuant数据：最近5日发现 3 日量价背离，总得分: 1.84
    背离详情: 20251015 (量缩19.5%, +0.97分); 20251016 (量缩7.7%, +0.34分); 20251020 (量缩11.1%, +0.53分)
```

#### 3. 总分范围调整

**变更**:
- 融资余额：0-1.0分
- 开户数：0-1.5分
- **量价背离：0-1.0+分 → 0-5.0分** ⭐ 大幅提升
- 估值百分位：0-1.0分
- **总分范围：0-4.5分 → 0-8.5分**

**逃顶阈值建议**:
- 保持2.2分作为基础阈值
- 3.0分以上：强烈警告
- 4.0分以上：极度危险

#### 4. 估值百分位数据源和规则优化 ⭐

**变更内容**:
- ✅ 数据源：akshare → Wind API
- ✅ 指数：上证指数 → Wind全A指数 (881001.WI)
- ✅ 下限阈值：80% → 60% (更早预警)

**新规则**:
- 百分位≥95% → 1.0分
- 百分位≤60% → 0.0分 (原80%)
- 百分位60%-95% → 线性插值

**优势**:
- Wind API数据更可靠
- Wind全A指数更全面
- 60%阈值更早预警

#### 5. 新增测试工具

**文件**: 
- `量价背离评分测试.py` - 量价背离规则测试
- `测试Wind估值.py` - Wind估值数据测试

**功能**:
- ✅ 单日得分测试（0%-30%萎缩率）
- ✅ 多日累计场景测试（5个典型场景）
- ✅ 新旧规则对比
- ✅ 实际案例验证
- ✅ Wind估值数据获取测试

**运行**:
```bash
python src/大盘逃顶/量价背离评分测试.py
python src/大盘逃顶/测试Wind估值.py
```

---

## 2025-10-20 更新 v1.0.5

### 🔄 融资余额评分规则优化

#### 1. 增加1日为负评分

**变更内容**:
- 新增：1日为负 → 0.2分

**完整规则**:
- 3日全为负 → 1.0分
- 2日为负 → 0.4分
- **1日为负 → 0.2分** ⭐ 新增
- 其他情况 → 0分

**原因**:
- 更精细的风险分级
- 单日异常也应有所反映
- 提高预警敏感度

#### 2. 量价背离数据源优化 ⭐

**变更内容**:
- ✅ 改用标准 XtQuant 接口 (`getDayData`)
- ✅ 移除 akshare 备用方案
- ✅ 统一使用项目数据获取模块 (`source/实盘/xuntou/datadownload/合并下载数据.py`)

**优势**:
- 数据源统一，更易维护
- 利用本地缓存，提升性能
- 减少外部依赖

**修复内容**:
- ✅ 增加数据不足的提示信息
- ✅ 数据获取失败时显示"⚠ 无法获取量价背离数据，默认得分: 0.00"
- ✅ 显示量价背离的具体日期和萎缩幅度

**新增工具**:
- `测试量价背离.py` - 诊断量价背离数据获取问题
- `融资余额评分测试.py` - 测试融资余额评分规则

---

## 2025-10-20 更新 v1.0.4

### 🔄 开户数据获取最终优化

#### 1. 移除 akshare 备用方案

**变更内容**:
- **仅使用 Wind API** 获取开户数据
- 移除 akshare 备用方案（数据只到2023年8月）

**原因**:
- akshare 数据已过时，停止更新
- Wind API 提供最新、最准确的数据
- 简化代码逻辑，提高可维护性

**Wind API 接口**:
```python
# 使用 Wind 经济数据库接口
# M0010401: 新增投资者数量（万户）
data = w.edb("M0010401", start_date, end_date, "Fill=Previous")

# 转换为DataFrame
df_wind = pd.DataFrame({
    'date': data.Times,
    'value': data.Data[0]
})

# 按日期降序，取最近两个月
df_wind = df_wind.sort_values('date', ascending=False).head(2)
```

**数据字段**: M0010401 - 新增投资者数量（万户）

---

## 2025-10-20 更新 v1.0.3

### 🔄 开户数据获取优化（已废弃）

~~此版本使用 akshare 优先，但因数据过时已在 v1.0.4 中移除~~

#### 2. 评分规则调整 ⭐ 重要

**变更内容**:
- 环比降幅 ≥30% → **1.5分**（原1.0分）
- 环比降幅 0% → 0分
- 环比降幅 0-30% → 按比例到1.5分（原1.0分）

**影响**:
- 开户数最高分从1.0分提升到1.5分
- 总分范围从4分变为4.5分
- 更加重视开户数下降的风险信号

**评分公式**:
```python
if decline_rate >= 30:
    score = 1.5  # 修改
elif decline_rate > 0:
    score = decline_rate / 30.0 * 1.5  # 修改
else:
    score = 0.0
```

---

## 2025-10-20 更新 v1.0.2

### 🔧 Bug修复

#### 1. Wind API 导入错误修复

**问题**: 运行时出现 `module 'WindPy' has no attribute 'start'`

**原因**: Wind API 导入方式错误
```python
# ❌ 错误
import WindPy as w
w.start()
```

**修复**: 
```python
# ✅ 正确
from WindPy import w
w.start()
```

**影响范围**:
- ✅ `escape_top_scorer.py` - 融资余额获取
- ✅ `escape_top_scorer.py` - 开户数获取
- ✅ `test_data_sources.py` - Wind API 测试

#### 2. Wind API 融资余额获取方法修复 ⭐ 重要

**问题**: 使用 `w.wsd()` 方法获取融资净买入额不稳定

**原因**: 
- 之前使用 `w.wsd("881001.WI", "margin_netbuyamt", ...)` 
- 这不是获取融资余额数据的标准方法

**修复**: 改用 `w.wset()` 接口
```python
# ❌ 错误方法
data = w.wsd("881001.WI", "margin_netbuyamt", start_date, end_date, "")

# ✅ 正确方法
params = (
    f"exchange=all;"
    f"startdate={start_date};"
    f"enddate={end_date};"
    f"frequency=day;"
    f"sort=desc"
)
data = w.wset("margintradingsizeanalys(value)", params)

# 获取期间净买入额
df = pd.DataFrame(data.Data, index=data.Fields).T
df.columns = data.Fields
net_buy_values = df['period_net_purchases'].head(3).tolist()
```

**参考文档**:
- `md/winds/融资余额/示例代码.py`
- `md/winds/融资余额/融资余额API使用说明.md`

**优势**:
- ✅ 使用官方推荐的标准接口
- ✅ 数据更稳定可靠
- ✅ 字段名称更清晰（`period_net_purchases`）
- ✅ 支持多种频率（日/周/月）

### 📈 功能优化

#### 1. 融资余额数据获取优化

**改进内容**:
- 使用更准确的 Wind 字段 `margin_netbuyamt` (融资净买入额)
- 使用 `w.wsd()` 时间序列接口替代 `w.edb()`
- 增加数据验证和过滤 None 值
- 增加详细的数据输出（显示具体金额）

**示例输出**:
```
[1/4] 正在获取融资余额数据...
  ✓ Wind数据：融资净买入情况正常，得分: 0.0
    最近3日数据: ['89.23亿', '102.45亿', '76.89亿']
```

#### 2. 数据源降级机制保持不变

如果 Wind API 不可用，程序会自动切换到备用数据源：

```
融资余额: Wind API → 东方财富网API
开户数:   Wind API → akshare → 中国结算
量价背离: XtQuant → akshare
估值:     akshare
```

### 📝 新增文档

- ✅ `Wind_API使用说明.md` - Wind API 详细使用指南
- ✅ `更新日志.md` - 本文件

### ✅ 测试确认

运行以下命令测试修复：
```bash
# 测试所有数据源
python test_data_sources.py

# 运行主程序
python escape_top_scorer.py
```

**预期结果**:

如果已安装 Wind 终端并登录：
```
[测试 Wind API]
  ✓ Wind API 可用
  测试数据: 上证指数收盘价 3245.67
```

如果未安装 Wind：
```
[测试 Wind API]
  ✗ WindPy 未安装
  提示: 需要先安装Wind终端，然后 pip install WindPy
```

主程序会自动使用备用数据源，不影响运行：
```
[1/4] 正在获取融资余额数据...
  ✗ Wind API获取失败: No module named 'WindPy'
  → 尝试从东方财富网爬取数据...
  ✓ 东财数据：融资净买入情况正常，得分: 0.0
```

## 使用说明

### 对于有 Wind 终端的用户

1. **启动 Wind 终端并登录**
2. **确保 WindPy 已安装**:
   ```bash
   pip install WindPy
   ```
3. **运行程序**:
   ```bash
   python escape_top_scorer.py
   ```

**优势**: 数据更准确、更及时、更全面

### 对于没有 Wind 终端的用户

1. **使用简化版**:
   ```bash
   python escape_top_scorer_simple.py
   ```
   
   或使用完整版（会自动降级）:
   ```bash
   python escape_top_scorer.py
   ```

**说明**: 程序会自动使用 akshare 和东方财富网 API，无需额外配置

## 后续计划

### 可能的改进方向

1. **数据缓存**: 避免频繁请求 API
2. **异步获取**: 并发获取多个数据源，提高速度
3. **更多指标**: 
   - 北向资金净流入
   - 换手率
   - 市场广度指标
4. **通知功能**: 微信、邮件通知
5. **Web界面**: 提供可视化界面

### 问题反馈

如有问题，请提供以下信息：
1. 错误截图或错误信息
2. 运行环境（Windows/Linux/Mac）
3. Python 版本
4. 是否安装了 Wind 终端
5. 运行的是完整版还是简化版

---

**更新时间**: 2025-10-20 17:00  
**版本**: 1.0.1  
**状态**: ✅ 稳定版

