# v1.0.6 更新说明

## 🎯 核心变更：量价背离评分规则重构

### 变更概述

v1.0.6 对量价背离评分进行了重大重构，从**阶梯式计分**改为**连续比例计分**，大幅提升了风险预警的敏感度和精确度。

---

## 📊 评分规则对比

### 旧规则 (v1.0.5)

```python
# 只有萎缩≥20%才计分
if divergence_days == 1:
    score = 1.0
elif divergence_days >= 2:
    score = 1.0 + (divergence_days - 1) * 0.5
```

**特点**:
- 阈值高（20%）
- 阶梯式加分
- 分数范围：0-3分

### 新规则 (v1.0.6)

```python
# 萎缩≥5%就计分，按幅度比例
for 每日 in 最近5日:
    if 收盘涨 and 量缩率 >= 20%:
        day_score = 1.0
    elif 收盘涨 and 量缩率 >= 5%:
        day_score = 0.2 + (量缩率-0.05)/0.15 * 0.8
    else:
        day_score = 0.0
    
    total_score += day_score
```

**特点**:
- 阈值低（5%）
- 连续比例计分
- 分数范围：0-5分

---

## 🔢 计分公式详解

### 公式说明

```
萎缩率 < 5%:     0分      (不计分)
萎缩率 = 5%:     0.2分    (基础分)
萎缩率 5%-20%:   0.2 + (萎缩率-5%)/(20%-5%) * 0.8
萎缩率 ≥ 20%:    1.0分    (满分)
```

### 计算示例

| 萎缩率 | 计算过程 | 得分 |
|-------|---------|------|
| 3% | < 5%, 不计分 | **0.00** |
| 5% | = 5%, 基础分 | **0.20** |
| 8% | 0.2 + (0.08-0.05)/0.15*0.8 | **0.36** |
| 10% | 0.2 + (0.10-0.05)/0.15*0.8 | **0.47** |
| 15% | 0.2 + (0.15-0.05)/0.15*0.8 | **0.73** |
| 20% | ≥ 20%, 满分 | **1.00** |
| 25% | ≥ 20%, 满分 | **1.00** |

---

## 📈 典型场景对比

### 场景1：轻度背离

**情况**: 3日萎缩10%

| 版本 | 得分 | 说明 |
|------|------|------|
| v1.0.5 | 0.00 | 未达20%阈值，不计分 |
| v1.0.6 | **1.40** | 3 × 0.47 = 1.40分 ⭐ |

**差异**: +1.40分 - **新规则能提前发现轻度风险**

### 场景2：中度背离

**情况**: 2日萎缩15%，1日萎缩25%

| 版本 | 得分 | 计算过程 |
|------|------|---------|
| v1.0.5 | 1.50 | 1日达标 → 1.0 + 0.5 |
| v1.0.6 | **2.47** | 2×0.73 + 1.0 = 2.47 ⭐ |

**差异**: +0.97分 - **更准确反映实际风险**

### 场景3：重度背离

**情况**: 连续5日萎缩25%

| 版本 | 得分 | 计算过程 |
|------|------|---------|
| v1.0.5 | 3.00 | 1.0 + (5-1)×0.5 = 3.0 |
| v1.0.6 | **5.00** | 5 × 1.0 = 5.0 ⭐ |

**差异**: +2.00分 - **极端情况得分更高**

### 场景4：实际案例（2025-10-20）

**情况**: 19.5%, 7.7%, 11.1%

| 版本 | 得分 | 计算过程 |
|------|------|---------|
| v1.0.5 | 1.00 | 1日达标 → 1.0分 |
| v1.0.6 | **1.84** | 0.97 + 0.34 + 0.53 = 1.84 ⭐ |

**差异**: +0.84分 - **更精细地反映市场状况**

---

## 🎯 优势分析

### 1. 更早发现风险

**旧规则**: 必须萎缩≥20%才预警  
**新规则**: 萎缩≥5%就开始预警 ⭐

**意义**: 提前发现市场情绪转变

### 2. 更精细的分级

**旧规则**: 只有0分、1分、1.5分、2分...（离散）  
**新规则**: 0.2分、0.36分、0.47分...（连续） ⭐

**意义**: 更准确量化风险程度

### 3. 更合理的累计

**旧规则**: 固定加分（1, 1.5, 2.0, 2.5...）  
**新规则**: 按实际萎缩率求和 ⭐

**意义**: 真实反映累计风险

### 4. 更大的分数范围

**旧规则**: 0-3分  
**新规则**: 0-5分 ⭐

**意义**: 更好区分不同风险级别

---

## 💡 使用建议

### 1. 逃顶阈值调整

由于量价背离得分范围扩大，建议调整阈值判断：

| 总分范围 | 风险等级 | 建议操作 |
|---------|---------|---------|
| < 2.2 | 正常 | 继续持有 |
| 2.2-3.0 | 轻度风险 | 保持警惕 |
| 3.0-4.0 | 中度风险 | 考虑减仓 |
| ≥ 4.0 | 高度风险 | 立即减仓 ⭐ |

### 2. 配合其他指标

量价背离得分提升后，建议：
- 不要单独依赖量价背离
- 综合考虑融资余额、开户数、估值
- 关注多个指标同时预警的情况

### 3. 历史回测

建议使用新规则对历史数据进行回测，验证：
- 逃顶信号的准确率
- 最佳的阈值设置
- 与实际市场顶部的吻合度

---

## 🧪 测试工具

### 运行测试

```bash
python src/大盘逃顶/量价背离评分测试.py
```

### 测试内容

1. **单日得分测试**
   - 测试0%-30%各个萎缩率的得分
   - 验证计分公式正确性

2. **多日累计测试**
   - 5个典型场景
   - 正常/轻度/中度/高度风险/实际案例

3. **新旧规则对比**
   - 4个典型场景对比
   - 量化优势差异

---

## 📝 代码变更

### 主要修改

**文件**: `src/大盘逃顶/escape_top_scorer.py`

**关键代码**:
```python
# 新增：按萎缩率比例计分
if price_up and volume_shrink_rate >= 0.05:
    if volume_shrink_rate >= 0.20:
        day_score = 1.0
    else:
        day_score = 0.2 + (volume_shrink_rate - 0.05) / 0.15 * 0.8
    
    total_score += day_score
```

### 新增文件

- ✅ `量价背离评分测试.py` - 完整的测试工具
- ✅ `v1.0.6更新说明.md` - 本文档

### 文档更新

- ✅ `README.md` - 评分规则更新
- ✅ `更新日志.md` - 添加v1.0.6说明
- ✅ `escape_top_scorer.py` - 函数文档字符串更新

---

## ⚠️ 注意事项

### 1. 总分范围变化

- **旧版本**: 0-4.5分
- **新版本**: 0-8.5分

**影响**: 
- 历史数据对比可能不准确
- 建议重新生成历史趋势图

### 2. 兼容性

- ✅ 代码向后兼容
- ✅ 历史CSV数据可以继续使用
- ⚠️ 但分数含义已变化

### 3. 升级建议

如果从旧版本升级：
1. 备份历史数据
2. 了解新的评分规则
3. 重新设置逃顶阈值
4. 运行测试验证

---

## 🎉 总结

v1.0.6 的量价背离评分重构是一次重大升级：

✅ **更敏感** - 5%即预警  
✅ **更精细** - 连续计分  
✅ **更合理** - 按实际萎缩率  
✅ **更准确** - 真实反映风险  

建议所有用户升级到v1.0.6，体验更智能的逃顶预警系统！

---

**版本**: v1.0.6  
**发布日期**: 2025-10-20  
**重要程度**: ⭐⭐⭐⭐⭐  
**推荐升级**: 强烈推荐

