# A股牛市逃顶打分器 - 项目说明

## 📁 项目结构

```
src/大盘逃顶/
├── escape_top_scorer.py          # 完整版主程序（使用Wind/XtQuant）
├── escape_top_scorer_simple.py   # 简化版主程序（仅使用akshare/东财）⭐推荐
├── test_data_sources.py          # 数据源测试工具
├── config_example.py             # 配置文件示例
├── requirements.txt              # Python依赖包
├── run.bat                       # Windows快速启动脚本
├── run.sh                        # Linux/Mac快速启动脚本
├── README.md                     # 项目说明文档
├── 使用指南.md                   # 详细使用指南
├── 项目说明.md                   # 本文件
├── .gitignore                    # Git忽略配置
│
├── escape_top_history.csv        # 历史评分数据（运行后生成）
└── escape_top_chart.png          # 趋势图表（运行后生成）
```

## 🎯 核心功能

### 4个评分指标

| 指标 | 满分 | 数据源 | 更新频率 |
|------|-----|--------|---------|
| 融资余额 | 1.0 | Wind/东方财富网 | 每日 |
| 开户数 | 1.0 | Wind/akshare | 每月 |
| 量价背离 | 1.0+ | XtQuant/akshare | 每日 |
| 估值百分位 | 1.0 | akshare | 每日 |

**逃顶信号阈值**: 总分 ≥ 2.2分

### 评分逻辑

#### 1. 融资余额 (0-1分)
```
最近3日融资净买入全为负  → 1.0分
最近3日有2日为负        → 0.4分
其他情况               → 0.0分
```

#### 2. 开户数 (0-1分)
```
环比降幅 ≥ 30%  → 1.0分
环比降幅 = 0%   → 0.0分
环比降幅 0-30%  → 线性插值
```

#### 3. 量价背离 (0-1分+)
```
检查最近5日，每发现1日"收盘涨 & 成交量萎缩≥20%"：
1日  → 1.0分
2日  → 1.5分
3日+ → 继续+0.5分/日
```

#### 4. 估值百分位 (0-1分)
```
PE百分位 ≥ 95%  → 1.0分
PE百分位 ≤ 80%  → 0.0分
PE百分位 80-95% → 线性插值
```

## 🔧 技术实现

### 数据源优先级

#### 完整版 (escape_top_scorer.py)
1. **融资余额**: Wind API → 东方财富网
2. **开户数**: Wind API → akshare → 中国结算
3. **量价背离**: XtQuant → akshare
4. **估值百分位**: akshare

#### 简化版 (escape_top_scorer_simple.py)
1. **融资余额**: 东方财富网API
2. **开户数**: akshare
3. **量价背离**: akshare
4. **估值百分位**: akshare

### 数据处理流程

```
1. 数据获取
   ↓
2. 数据清洗和验证
   ↓
3. 指标计算
   ↓
4. 评分计算
   ↓
5. 结果输出（终端+CSV+图表）
   ↓
6. 历史数据保存
```

### 关键代码结构

```python
class EscapeTopScorer:
    def __init__(self):
        """初始化打分器"""
        
    def get_financing_balance_score(self):
        """获取融资余额得分"""
        
    def get_new_accounts_score(self):
        """获取开户数得分"""
        
    def get_volume_divergence_score(self):
        """获取量价背离得分"""
        
    def get_valuation_percentile_score(self):
        """获取估值百分位得分"""
        
    def calculate_total_score(self):
        """计算总分"""
        
    def print_result(self):
        """打印结果"""
        
    def save_to_history(self):
        """保存历史记录"""
        
    def plot_history_chart(self):
        """绘制趋势图"""
        
    def run(self):
        """运行完整流程"""
```

## 📊 输出示例

### 终端输出

```
======================================================================
A股牛市逃顶打分器 (简化版)
运行时间: 2025-10-20 16:30:00
======================================================================

[1/4] 正在获取融资余额数据（东方财富网）...
  ✓ 最近3日融资净买入全为负
    数据: -123.45亿, -87.65亿, -56.78亿
  得分: 1.0

[2/4] 正在获取开户数数据（akshare）...
  ✓ 最近两期: 156.32万 → 132.18万
    环比变化: -15.4% (降幅: 15.4%)
  得分: 0.51

[3/4] 正在获取量价背离数据（akshare）...
  ✓ 发现 2 日量价背离
    10-18: 价涨+1.23%, 量缩25.6%
    10-19: 价涨+0.87%, 量缩31.2%
  得分: 1.50

[4/4] 正在获取估值百分位数据（akshare）...
  ✓ 当前PE: 15.67
    近5年百分位: 88.5%
  得分: 0.57

======================================================================
2025-10-20 逃顶打分
======================================================================
融资余额: 1.0 | 开户数: 0.5 | 量价背离: 1.5 | 估值百分位: 0.6

总分: 3.6/4
----------------------------------------------------------------------
【⚠️  强烈逃顶信号！】
======================================================================

✓ 历史数据已保存到: D:\pythonProject\数据源\src\大盘逃顶\escape_top_history.csv
✓ 趋势图已保存到: D:\pythonProject\数据源\src\大盘逃顶\escape_top_chart.png
```

### CSV文件格式

```csv
date,financing_score,account_score,divergence_score,valuation_score,total_score
2025-10-18,0.4,0.5,1.0,0.6,2.5
2025-10-19,1.0,0.5,1.5,0.6,3.6
2025-10-20,1.0,0.5,1.5,0.6,3.6
```

### 图表输出

生成两个子图：
1. **总分趋势图**: 显示近3个月每日总分，标注逃顶警戒线和危险点
2. **指标分布图**: 堆叠面积图，展示各指标对总分的贡献

## 🚀 使用场景

### 1. 日常监控
- 每天收盘后运行，监测市场风险
- 观察趋势图，了解风险变化趋势

### 2. 投资决策辅助
- 总分 < 1.0: 市场较为安全，可以持仓
- 总分 1.0-2.0: 市场有一定风险，需要关注
- 总分 ≥ 2.2: 强烈逃顶信号，建议减仓

### 3. 回测分析
- 积累历史数据，验证模型有效性
- 对比历史牛市顶部的评分情况
- 优化评分规则和阈值

### 4. 自动化运行
- 配置Windows任务计划或Linux crontab
- 每日自动运行，发送结果通知

## 📈 扩展建议

### 功能扩展
1. **通知功能**: 添加邮件/微信通知
2. **更多指标**: 增加北向资金、两融占比等指标
3. **个股分析**: 扩展到个股逃顶分析
4. **历史回测**: 自动回测历史准确率

### 技术优化
1. **数据缓存**: 减少API调用次数
2. **异步获取**: 并发获取多个数据源
3. **错误重试**: 增加失败重试机制
4. **日志系统**: 完善日志记录

## ⚠️ 免责声明

本工具仅供学习和研究使用，不构成任何投资建议。

- 指标基于历史经验，可能存在滞后或误判
- 市场情况复杂多变，需结合其他分析方法
- 投资有风险，使用本工具产生的任何后果，用户需自行承担责任

## 📞 技术支持

- 问题反馈: 提交GitHub Issue
- 功能建议: 欢迎Pull Request
- 技术交流: 参考README和使用指南

---

**版本**: 1.0.0
**更新日期**: 2025-10-20
**作者**: AI Assistant
**许可**: MIT License

